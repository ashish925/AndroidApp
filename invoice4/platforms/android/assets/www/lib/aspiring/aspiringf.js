var SocialCalc;if(!SocialCalc){SocialCalc={}}SocialCalc.Formula={};SocialCalc.Formula.ParseState={num:1,alpha:2,coord:3,string:4,stringquote:5,numexp1:6,numexp2:7,alphanumeric:8,specialvalue:9};SocialCalc.Formula.TokenType={num:1,coord:2,op:3,name:4,error:5,string:6,space:7};SocialCalc.Formula.CharClass={num:1,numstart:2,op:3,eof:4,alpha:5,incoord:6,error:7,quote:8,space:9,specialstart:10};SocialCalc.Formula.CharClassTable={" ":9,"!":3,'"':8,"#":10,"$":6,"%":3,"&":3,"(":3,")":3,"*":3,"+":3,",":3,"-":3,".":2,"/":3,"0":1,"1":1,"2":1,"3":1,"4":1,"5":1,"6":1,"7":1,"8":1,"9":1,":":3,"<":3,"=":3,">":3,A:5,B:5,C:5,D:5,E:5,F:5,G:5,H:5,I:5,J:5,K:5,L:5,M:5,N:5,O:5,P:5,Q:5,R:5,S:5,T:5,U:5,V:5,W:5,X:5,Y:5,Z:5,"^":3,_:5,a:5,b:5,c:5,d:5,e:5,f:5,g:5,h:5,i:5,j:5,k:5,l:5,m:5,n:5,o:5,p:5,q:5,r:5,s:5,t:5,u:5,v:5,w:5,x:5,y:5,z:5};SocialCalc.Formula.UpperCaseTable={a:"A",b:"B",c:"C",d:"D",e:"E",f:"F",g:"G",h:"H",i:"I",j:"J",k:"K",l:"L",m:"M",n:"N",o:"O",p:"P",q:"Q",r:"R",s:"S",t:"T",u:"U",v:"V",w:"W",x:"X",y:"Y",z:"Z"};SocialCalc.Formula.SpecialConstants={"#NULL!":"0,e#NULL!","#NUM!":"0,e#NUM!","#DIV/0!":"0,e#DIV/0!","#VALUE!":"0,e#VALUE!","#REF!":"0,e#REF!","#NAME?":"0,e#NAME?"};SocialCalc.Formula.TokenPrecedence={"!":1,":":2,",":2,M:-3,P:-3,"%":4,"^":5,"*":6,"/":6,"+":7,"-":7,"&":8,"<":9,">":9,G:9,L:9,N:9};SocialCalc.Formula.TokenOpExpansion={G:">=",L:"<=",M:"-",N:"<>",P:"+"};SocialCalc.Formula.TypeLookupTable={unaryminus:{"n*":"|n*:1|","e*":"|e*:1|","t*":"|t*:e#VALUE!|",b:"|b:n|"},unaryplus:{"n*":"|n*:1|","e*":"|e*:1|","t*":"|t*:e#VALUE!|",b:"|b:n|"},unarypercent:{"n*":"|n:n%|n*:n|","e*":"|e*:1|","t*":"|t*:e#VALUE!|",b:"|b:n|"},plus:{"n%":"|n%:n%|nd:n|nt:n|ndt:n|n$:n|n:n|n*:n|b:n|e*:2|t*:e#VALUE!|",nd:"|n%:n|nd:nd|nt:ndt|ndt:ndt|n$:n|n:nd|n*:n|b:n|e*:2|t*:e#VALUE!|",nt:"|n%:n|nd:ndt|nt:nt|ndt:ndt|n$:n|n:nt|n*:n|b:n|e*:2|t*:e#VALUE!|",ndt:"|n%:n|nd:ndt|nt:ndt|ndt:ndt|n$:n|n:ndt|n*:n|b:n|e*:2|t*:e#VALUE!|","n$":"|n%:n|nd:n|nt:n|ndt:n|n$:n$|n:n$|n*:n|b:n|e*:2|t*:e#VALUE!|",nl:"|n%:n|nd:n|nt:n|ndt:n|n$:n|n:n|n*:n|b:n|e*:2|t*:e#VALUE!|",n:"|n%:n|nd:nd|nt:nt|ndt:ndt|n$:n$|n:n|n*:n|b:n|e*:2|t*:e#VALUE!|",b:"|n%:n%|nd:nd|nt:nt|ndt:ndt|n$:n$|n:n|n*:n|b:n|e*:2|t*:e#VALUE!|","t*":"|n*:e#VALUE!|t*:e#VALUE!|b:e#VALUE!|e*:2|","e*":"|e*:1|n*:1|t*:1|b:1|"},concat:{t:"|t:t|th:th|tw:tw|tl:t|t*:2|e*:2|",th:"|t:th|th:th|tw:t|tl:th|t*:t|e*:2|",tw:"|t:tw|th:t|tw:tw|tl:tw|t*:t|e*:2|",tl:"|t:tl|th:th|tw:tw|tl:tl|t*:t|e*:2|","e*":"|e*:1|n*:1|t*:1|"},oneargnumeric:{"n*":"|n*:n|","e*":"|e*:1|","t*":"|t*:e#VALUE!|",b:"|b:n|"},twoargnumeric:{"n*":"|n*:n|t*:e#VALUE!|e*:2|","e*":"|e*:1|n*:1|t*:1|","t*":"|t*:e#VALUE!|n*:e#VALUE!|e*:2|"},propagateerror:{"n*":"|n*:2|e*:2|","e*":"|e*:2|","t*":"|t*:2|e*:2|",b:"|b:2|e*:2|"}};SocialCalc.Formula.ParseFormulaIntoTokens=function(h){var s,j,f,u,o,c,l,k;var b=SocialCalc.Formula;var d=SocialCalc.Constants;var a=b.ParseState;var p=b.TokenType;var v=b.CharClass;var m=b.CharClassTable;var r=b.UpperCaseTable;var g=b.ParsePushToken;var w=/^\$?[A-Z]{1,2}\$?[1-9]\d*$/i;var q=[];var n="";var e=0;var u=false;for(s=0;s<=h.length;s++){if(s<h.length){j=h.charAt(s);cclass=m[j]}else{j="";cclass=v.eof}if(e==a.num){if(cclass==v.num){n+=j}else{if(cclass==v.numstart&&!u){u=true;n+=j}else{if(j=="E"||j=="e"){n+=j;u=false;e=a.numexp1}else{g(q,n,p.num,0);u=false;e=0}}}}if(e==a.numexp1){if(cclass==a.num){e=a.numexp2}else{if((j=="+"||j=="-")&&(r[n.charAt(n.length-1)]=="E")){n+=j}else{if(j=="E"||j=="e"){}else{g(q,d.s_parseerrexponent,p.error,0);e=0}}}}if(e==a.numexp2){if(cclass==v.num){n+=j}else{g(q,n,p.num,0);e=0}}if(e==a.alpha){if(cclass==v.num){e=a.coord}else{if(cclass==v.alpha||j=="."){n+=j}else{if(cclass==v.incoord){e=a.coord}else{if(cclass==v.op||cclass==v.numstart||cclass==v.space||cclass==v.eof){g(q,n.toUpperCase(),p.name,0);e=0}else{g(q,d.s_parseerrchar,p.error,0);e=0}}}}}if(e==a.coord){if(cclass==v.num){n+=j}else{if(cclass==v.incoord){n+=j}else{if(cclass==v.alpha){e=a.alphanumeric}else{if(cclass==v.op||cclass==v.numstart||cclass==v.eof||cclass==v.space){if(w.test(n)){k=p.coord}else{k=p.name}g(q,n.toUpperCase(),k,0);e=0}else{g(q,d.s_parseerrchar,p.error,0);e=0}}}}}if(e==a.alphanumeric){if(cclass==v.num||cclass==v.alpha){n+=j}else{if(cclass==v.op||cclass==v.numstart||cclass==v.space||cclass==v.eof){g(q,n.toUpperCase(),p.name,0);e=0}else{g(q,d.s_parseerrchar,p.error,0);e=0}}}if(e==a.string){if(cclass==v.quote){e=a.stringquote}else{if(cclass==v.eof){g(q,d.s_parseerrstring,p.error,0);e=0}else{n+=j}}}else{if(e==a.stringquote){if(cclass==v.quote){n+='"';e=a.string}else{g(q,n,p.string,0);e=0}}else{if(e==a.specialvalue){if(n.charAt(n.length-1)=="!"){g(q,n,p.name,0);e=0}else{if(cclass==v.eof){g(q,d.s_parseerrspecialvalue,p.error,0);e=0}else{n+=j}}}}}if(e==0){if(cclass==v.num){n=j;e=a.num}else{if(cclass==v.numstart){n=j;u=true;e=a.num}else{if(cclass==v.alpha||cclass==v.incoord){n=j;e=a.alpha}else{if(cclass==v.specialstart){n=j;e=a.specialvalue}else{if(cclass==v.op){n=j;if(q.length>0){o=q[q.length-1];c=o.type;l=o.text;if(c==v.op){if(l=="<"||l==">"){n=l+n;q.pop();if(q.length>0){o=q[q.length-1];c=o.type;l=o.text}else{c=v.eof;l="EOF"}}}}else{c=v.eof;l="EOF"}k=p.op;if((q.length==0)||(c==v.op&&l!=")"&&l!="%")){if(n=="-"){n="M";j="M"}else{if(n=="+"){n="P";j="P"}else{if(n==")"&&l=="("){}else{if(n!="("){k=p.error;n=d.s_parseerrtwoops}}}}}else{if(n.length>1){if(n==">="){n="G";j="G"}else{if(n=="<="){n="L";j="L"}else{if(n=="<>"){n="N";j="N"}else{k=p.error;n=d.s_parseerrtwoops}}}}}g(q,n,k,j);e=0}else{if(cclass==v.quote){n="";e=a.string}else{if(cclass==v.space){g(q," ",p.space,0)}else{if(cclass==v.eof){}else{g(q,d.s_parseerrchar,p.error,0)}}}}}}}}}}return q};SocialCalc.Formula.ParsePushToken=function(c,a,d,b){c.push({text:a,type:d,opcode:b})};SocialCalc.Formula.evaluate_parsed_formula=function(h,g,d){var i;var b=SocialCalc.Formula;var e=b.TokenType;var a;var f=[];var c="";a=b.ConvertInfixToPolish(h);i=b.EvaluatePolish(h,a,g,d);return i};SocialCalc.Formula.ConvertInfixToPolish=function(m){var b=SocialCalc.Formula;var f=SocialCalc.Constants;var h=b.TokenType;var p=b.TokenPrecedence;var a=[];var k=[];var c="";var o=-1;var g,e,j,n,l,d;for(g=0;g<m.length;g++){e=m[g];j=e.type;n=e.text;if(j==h.num||j==h.coord||j==h.string){a.push(g)}else{if(j==h.name){k.push(g);a.push(o)}else{if(j==h.space){continue}else{if(n==","){while(k.length&&m[k[k.length-1]].text!="("){a.push(k.pop())}if(k.length==0){c=f.s_parseerrmissingopenparen;break}}else{if(n=="("){k.push(g)}else{if(n==")"){while(k.length&&m[k[k.length-1]].text!="("){a.push(k.pop())}if(k.length==0){c=f.s_parseerrcloseparennoopen;break}k.pop();if(k.length&&m[k[k.length-1]].type==h.name){a.push(k.pop())}}else{if(j==h.op){if(k.length&&m[k[k.length-1]].type==h.name){a.push(k.pop())}while(k.length&&m[k[k.length-1]].type==h.op&&m[k[k.length-1]].text!="("){l=p[e.opcode];d=p[m[k[k.length-1]].opcode];if(l>=0&&l<d){break}else{if(l<0){l=-l;if(d<0){d=-d}if(l<=d){break}}}a.push(k.pop())}k.push(g)}else{if(j==h.error){c=n;break}else{c="Internal error while processing parsed formula. ";break}}}}}}}}}while(k.length>0){if(m[k[k.length-1]].text=="("){c=f.s_parseerrmissingcloseparen;break}a.push(k.pop())}if(c){return c}return a};SocialCalc.Formula.EvaluatePolish=function(y,H,j,C){var e=SocialCalc.Formula;var h=SocialCalc.Constants;var x=e.TokenType;var g=e.LookupResultType;var n=e.TypeLookupTable;var f=e.OperandAsNumber;var o=e.OperandAsText;var b=e.OperandValueAndType;var F=e.OperandsAsCoordOnSheet;var G=SocialCalc.format_number_for_display||function(i,I,J){return i+""};var v="";var a=-1;var s={value:"",type:"e#VALUE!",error:h.s_parseerrmissingoperand};var D=[];var w=function(I,i){D.push({type:I,value:i})};var B,t,k,A,d,r,q,l,z,c,u,m,E,p;if(!y.length||(!(H instanceof Array))){return({value:"",type:"e#VALUE!",error:(typeof H=="string"?H:"")})}for(B=0;B<H.length;B++){t=H[B];if(t==a){w("start",0);continue}k=y[t];A=k.type;d=k.text;if(A==x.num){w("n",d-0)}else{if(A==x.coord){w("coord",d)}else{if(A==x.string){w("t",d)}else{if(A==x.op){if(D.length<=0){return s;break}if(d=="M"){r=f(j,D);c=g(r.type,r.type,n.unaryminus);w(c,-r.value)}else{if(d=="P"){r=f(j,D);c=g(r.type,r.type,n.unaryplus);w(c,r.value)}else{if(d=="%"){r=f(j,D);c=g(r.type,r.type,n.unarypercent);w(c,0.01*r.value)}else{if(d=="&"){if(D.length<=1){return s}q=o(j,D);r=o(j,D);c=g(r.type,r.type,n.concat);w(c,r.value+q.value)}else{if(d==":"){if(D.length<=1){return s}r=e.OperandsAsRangeOnSheet(j,D);if(r.error){v=v||r.error}w(r.type,r.value)}else{if(d=="!"){if(D.length<=1){return s}r=F(j,D);if(r.error){v=v||r.error}w(r.type,r.value)}else{if(d=="<"||d=="L"||d=="="||d=="G"||d==">"||d=="N"){if(D.length<=1){v=h.s_parseerrmissingoperand;break}q=b(j,D);r=b(j,D);if(r.type.charAt(0)=="n"&&q.type.charAt(0)=="n"){m=0;if(d=="<"){m=r.value<q.value?1:0}else{if(d=="L"){m=r.value<=q.value?1:0}else{if(d=="="){m=r.value==q.value?1:0}else{if(d=="G"){m=r.value>=q.value?1:0}else{if(d==">"){m=r.value>q.value?1:0}else{if(d=="N"){m=r.value!=q.value?1:0}}}}}}w("nl",m)}else{if(r.type.charAt(0)=="e"){w(r.type,0)}else{if(q.type.charAt(0)=="e"){w(q.type,0)}else{l=r.type.charAt(0);z=q.type.charAt(0);if(l=="n"){r.value=G(r.value,"n","")}else{if(l=="b"){r.value=""}}if(z=="n"){q.value=G(q.value,"n","")}else{if(z=="b"){q.value=""}}m=0;r.value=r.value.toLowerCase();q.value=q.value.toLowerCase();if(d=="<"){m=r.value<q.value?1:0}else{if(d=="L"){m=r.value<=q.value?1:0}else{if(d=="="){m=r.value==q.value?1:0}else{if(d=="G"){m=r.value>=q.value?1:0}else{if(d==">"){m=r.value>q.value?1:0}else{if(d=="N"){m=r.value!=q.value?1:0}}}}}}w("nl",m)}}}}else{if(D.length<=1){v=h.s_parseerrmissingoperand;break}q=f(j,D);r=f(j,D);if(d=="+"){c=g(r.type,q.type,n.plus);w(c,r.value+q.value)}else{if(d=="-"){c=g(r.type,q.type,n.plus);w(c,r.value-q.value)}else{if(d=="*"){c=g(r.type,q.type,n.plus);w(c,r.value*q.value)}else{if(d=="/"){if(q.value!=0){w("n",r.value/q.value)}else{w("e#DIV/0!",0)}}else{if(d=="^"){r.value=Math.pow(r.value,q.value);r.type="n";if(isNaN(r.value)){r.value=0;r.type="e#NUM!"}w(r.type,r.value)}}}}}}}}}}}}}else{if(A==x.name){v=e.CalculateFunction(d,D,j);if(v){break}}else{v=h.s_InternalError+"Unknown token "+A+" ("+d+"). ";break}}}}}}value=D[0]?D[0].value:"";l=D[0]?D[0].type:"";if(l=="name"){r=SocialCalc.Formula.LookupName(j,value);value=r.value;l=r.type;v=v||r.error}if(l=="coord"){r=b(j,D);value=r.value;l=r.type;if(l=="b"){l="n";value=0}}if(D.length>1&&!v){v+=h.s_parseerrerrorinformula}u=l;if(l.charAt(0)=="e"){v=v||l.substring(1)||h.s_calcerrerrorvalueinformula}else{if(l=="range"){E=value.match(/^(.*)\|(.*)\|/);p=E[1].indexOf("!");if(p>=0){E[1]=E[1].substring(p+1)+"!"+E[1].substring(0,p).toUpperCase()}else{E[1]=E[1].toUpperCase()}value=E[1]+":"+E[2].toUpperCase();if(!C){v=h.s_formularangeresult+" "+value}}}if(v&&u.charAt(0)!="e"){value=v;u="e"}if(u.charAt(0)=="n"&&(isNaN(value)||!isFinite(value))){value=0;u="e#NUM!";v=isNaN(value)?h.s_calcerrnumericnan:h.s_calcerrnumericoverflow}return({value:value,type:u,error:v})};SocialCalc.Formula.LookupResultType=function(e,b,g){var f,d,a;var c=g[e];if(!c){c=g[e.charAt(0)+"*"];if(!c){return"e#VALUE! (internal error, missing LookupResultType "+e.charAt(0)+"*)"}}f=c.indexOf("|"+b+":");if(f>=0){d=c.indexOf("|",f+1);if(d<0){return"e#VALUE! (internal error, incorrect LookupResultType "+c+")"}a=c.substring(f+b.length+2,d);if(a=="1"){return e}if(a=="2"){return b}return a}f=c.indexOf("|"+b.charAt(0)+"*:");if(f>=0){d=c.indexOf("|",f+1);if(d<0){return"e#VALUE! (internal error, incorrect LookupResultType "+c+")"}a=c.substring(f+4,d);if(a=="1"){return e}if(a=="2"){return b}return a}return"e#VALUE!"};SocialCalc.Formula.TopOfStackValueAndType=function(e,d){var g,h,f,b;var c=SocialCalc.Formula;var i={type:"",value:""};var a=d.length;if(!a){i.error=SocialCalc.Constants.s_InternalError+"no operand on stack";return i}i.value=d[a-1].value;i.type=d[a-1].type;d.pop();if(i.type=="name"){i=c.LookupName(e,i.value)}return i};SocialCalc.Formula.OperandAsNumber=function(d,b){var c,e;var a=SocialCalc.Formula.OperandValueAndType(d,b);c=a.type.charAt(0);if(c=="n"){a.value=a.value-0}else{if(c=="b"){a.type="n";a.value=0}else{if(c=="e"){a.value=0}else{e=SocialCalc.DetermineValueType?SocialCalc.DetermineValueType(a.value):{value:a.value-0,type:"n"};if(e.type.charAt(0)=="n"){a.value=e.value-0;a.type=e.type}else{a.value=0;a.type=e.type}}}}return a};SocialCalc.Formula.OperandAsText=function(d,b){var c,e;var a=SocialCalc.Formula.OperandValueAndType(d,b);c=a.type.charAt(0);if(c=="t"){}else{if(c=="n"){a.value=SocialCalc.format_number_for_display?SocialCalc.format_number_for_display(a.value,a.type,""):a.value=a.value+"";a.type="t"}else{if(c=="b"){a.value="";a.type="t"}else{if(c=="e"){a.value=""}else{b.value=a.value+"";b.type="t"}}}}return a};SocialCalc.Formula.OperandValueAndType=function(e,d){var g,h,f,b;var c=SocialCalc.Formula;var i={type:"",value:""};var a=d.length;if(!a){i.error=SocialCalc.Constants.s_InternalError+"no operand on stack";return i}i.value=d[a-1].value;i.type=d[a-1].type;d.pop();if(i.type=="name"){i=c.LookupName(e,i.value)}if(i.type=="range"){i=c.StepThroughRangeDown(d,i.value)}if(i.type=="coord"){b=e;f=i.value.indexOf("!");if(f!=-1){b=c.FindInSheetCache(i.value.substring(f+1));if(b==null){i.type="e#REF!";i.error=SocialCalc.Constants.s_sheetunavailable+" "+i.value.substring(f+1);i.value=0;return i}i.value=i.value.substring(0,f)}if(b){h=b.cells[SocialCalc.Formula.PlainCoord(i.value)];if(h){g=h.valuetype;i.value=h.datavalue}else{g="b"}}else{g="e#N/A";i.value=0}i.type=g||"b";if(i.type=="b"){i.value=0}}return i};SocialCalc.Formula.OperandAsCoord=function(d,c){var e=SocialCalc.Formula;var b={type:"",value:""};var a=c.length;b.value=c[a-1].value;b.type=c[a-1].type;c.pop();if(b.type=="name"){b=SocialCalc.Formula.LookupName(d,b.value)}if(b.type=="coord"){return b}else{b.value=SocialCalc.Constants.s_calcerrcellrefmissing;b.type="e#REF!";return b}};SocialCalc.Formula.OperandsAsCoordOnSheet=function(e,d){var h,c,i,f;var g={};var j={};var b=SocialCalc.Formula;var a=d.length;g.value=d[a-1].value;g.type=d[a-1].type;d.pop();h=b.OperandAsSheetName(e,d);c=b.FindInSheetCache(h.value);if(c==null){j.type="e#REF!";j.value=0;j.error=SocialCalc.Constants.s_sheetunavailable+" "+h.value;return j}if(g.type=="name"){g=b.LookupName(c,g.value)}j.type=g.type;if(g.type=="coord"){j.value=g.value+"!"+h.value}else{if(g.type=="range"){i=g.value.indexOf("|");f=g.value.indexOf("|",i+1);j.value=g.value.substring(0,i)+"!"+h.value+"|"+g.value.substring(i+1,f)+"|"}else{if(g.type.charAt(0)=="e"){j.value=g.value}else{j.error=SocialCalc.Constants.s_calcerrcellrefmissing;j.type="e#REF!";j.value=0}}}return j};SocialCalc.Formula.OperandsAsRangeOnSheet=function(f,e){var i,d,j,h;var g={};var b=SocialCalc.Formula;var c=SocialCalc.Constants;var a=e.length;g.value=e[a-1].value;g.type=e[a-1].type;e.pop();i=b.OperandAsCoord(f,e);if(i.type!="coord"){return{value:0,type:"e#REF!"}}d=f;j=i.value.indexOf("!");if(j!=-1){h=i.value.indexOf("|",j+1);if(h<0){h=i.value.length}d=b.FindInSheetCache(i.value.substring(j+1,h));if(d==null){return{value:0,type:"e#REF!",errortext:c.s_sheetunavailable+" "+i.value.substring(j+1,h)}}}if(g.type=="name"){g=b.LookupName(d,g.value)}if(g.type=="coord"){return{value:i.value+"|"+g.value+"|",type:"range"}}else{return{value:c.s_calcerrcellrefmissing,type:"e#REF!"}}};SocialCalc.Formula.OperandAsSheetName=function(e,d){var g,c;var f=SocialCalc.Formula;var b={type:"",value:""};var a=d.length;b.value=d[a-1].value;b.type=d[a-1].type;d.pop();if(b.type=="name"){g=SocialCalc.Formula.LookupName(e,b.value);if(!g.value){return b}b.value=g.value;b.type=g.type}if(b.type=="coord"){c=e.cells[SocialCalc.Formula.PlainCoord(b.value)];if(c){b.value=c.datavalue;b.type=c.valuetype}else{b.value="";b.type="b"}}if(b.type.charAt(0)=="t"){return b}else{b.value="";b.error=SocialCalc.Constants.s_calcerrsheetnamemissing;return b}};SocialCalc.Formula.LookupName=function(b,a){var h,c,e;var f=b.names;var d={};var g=false;if(f[a.toUpperCase()]){d.value=f[a.toUpperCase()].definition;if(d.value.charAt(0)=="="){if(!b.checknamecirc){b.checknamecirc={};g=true}else{if(b.checknamecirc[a]){d.type="e#NAME?";d.error=SocialCalc.Constants.s_circularnameref+' "'+a+'".';return d}}b.checknamecirc[a]=true;e=SocialCalc.Formula.ParseFormulaIntoTokens(d.value.substring(1));d=SocialCalc.Formula.evaluate_parsed_formula(e,b,1);delete b.checknamecirc[a];if(g){delete b.checknamecirc}if(d.type!="range"){return d}}h=d.value.indexOf(":");if(h!=-1){d.type="range";d.value=d.value.substring(0,h)+"|"+d.value.substring(h+1)+"|";d.value=d.value.toUpperCase()}else{d.type="coord";d.value=d.value.toUpperCase()}return d}else{if(c=SocialCalc.Formula.SpecialConstants[a.toUpperCase()]){h=c.indexOf(",");d.value=c.substring(0,h)-0;d.type=c.substring(h+1);return d}else{d.value="";d.type="e#NAME?";d.error=SocialCalc.Constants.s_calcerrunknownname+' "'+a+'"';return d}}};SocialCalc.Formula.StepThroughRangeDown=function(h,n){var l,j,d,m,k,e,f,i,a,g;var b=SocialCalc.Formula;m=n.indexOf("|");k=n.indexOf("|",m+1);l=n.substring(0,m);j=n.substring(m+1,k);d=n.substring(k+1)-0;m=l.indexOf("!");if(m!=-1){e=l.substring(m);l=l.substring(0,m)}else{e=""}m=j.indexOf("!");if(m!=-1){j=j.substring(0,m)}f=b.OrderRangeParts(l,j);g=0;for(a=f.r1;a<=f.r2;a++){for(i=f.c1;i<=f.c2;i++){g++;if(g>d){if(a!=f.r2||i!=f.c2){b.PushOperand(h,"range",l+e+"|"+j+"|"+g)}return{value:SocialCalc.crToCoord(i,a)+e,type:"coord"}}}}};SocialCalc.Formula.DecodeRangeParts=function(b,f){var i,g,j,h,d,c,e;var a=SocialCalc.Formula;j=f.indexOf("|");h=f.indexOf("|",j+1);i=f.substring(0,j);g=f.substring(j+1,h);j=i.indexOf("!");if(j!=-1){d=i.substring(j+1);i=i.substring(0,j)}else{d=""}j=g.indexOf("!");if(j!=-1){g=g.substring(0,j)}c=b;if(d){c=a.FindInSheetCache(d);if(c==null){return null}}e=a.OrderRangeParts(i,g);return{sheetdata:c,sheetname:d,col1num:e.c1,ncols:e.c2-e.c1+1,row1num:e.r1,nrows:e.r2-e.r1+1}};if(!SocialCalc.Formula.FunctionList){SocialCalc.Formula.FunctionList={}}SocialCalc.Formula.FunctionClasses=null;SocialCalc.Formula.FunctionArgDefs={};SocialCalc.Formula.CalculateFunction=function(c,g,h){var j,d,e,f,k;var a=SocialCalc.Formula;var i=1;var b="";j=a.FunctionList[c];if(j){d=[];e=j[0];f=j[1];a.CopyFunctionArgs(g,d);if(f!=100){if(f<0){if(d.length<-f){b=a.FunctionArgsError(c,g);return b}}else{if(d.length!=f){b=a.FunctionArgsError(c,g);return b}}}b=e(c,g,d,h)}else{k=c;if(g.length&&g[g.length-1].type=="start"){g.pop();a.PushOperand(g,"name",k)}else{b=SocialCalc.Constants.s_sheetfuncunknownfunction+" "+k+". "}}return b};SocialCalc.Formula.PushOperand=function(a,c,b){a.push({type:c,value:b})};SocialCalc.Formula.CopyFunctionArgs=function(a,e){var h,e,b,f;var g=SocialCalc.Formula;var d=1;var c=null;while(a.length>0&&a[a.length-1].type!="start"){e.push(a.pop())}a.pop();return};SocialCalc.Formula.FunctionArgsError=function(c,a){var b=SocialCalc.Constants.s_calcerrincorrectargstofunction+" "+c+". ";SocialCalc.Formula.PushOperand(a,"e#VALUE!",b);return b};SocialCalc.Formula.FunctionSpecificError=function(d,a,c,b){SocialCalc.Formula.PushOperand(a,c,b);return b};SocialCalc.Formula.CheckForErrorValue=function(a,b){if(b.type.charAt(0)=="e"){a.push(b);return true}else{return false}};SocialCalc.Formula.FillFunctionInfo=function(){var g=SocialCalc.Formula;var a=SocialCalc.Constants;var h,e,d,b,c;if(g.FunctionClasses){return}for(h in g.FunctionList){e=g.FunctionList[h];if(e[2]){g.FunctionArgDefs[e[2]]=a["s_farg_"+e[2]]||""}if(!e[3]){if(a["s_fdef_"+h]){g.FunctionList[h][3]=a["s_fdef_"+h]}}}g.FunctionClasses={};for(c=0;c<a.function_classlist.length;c++){b=a.function_classlist[c];g.FunctionClasses[b]={name:a["s_fclass_"+b],items:[]}}for(h in g.FunctionList){e=g.FunctionList[h];d=e[4]?e[4].split(","):[];d.push("all");for(c=0;c<d.length;c++){b=d[c];g.FunctionClasses[b].items.push(h)}}for(b in g.FunctionClasses){g.FunctionClasses[b].items.sort()}};SocialCalc.Formula.FunctionArgString=function(g){var f=SocialCalc.Formula;var c=f.FunctionList[g];var b,d,e;var a=c[2];if(!a){b=c[1];if(b==0){a=" "}else{if(b>0){e="v1";for(d=2;d<=b;d++){e+=", v"+d}return e}else{if(b<0){e="v1";for(d=2;d<-b;d++){e+=", v"+d}return e+", ..."}else{return"nargs: "+b}}}}e=f.FunctionArgDefs[a]||a;return e};SocialCalc.Formula.SeriesFunctions=function(x,u,j,h){var m,o,d;var f=SocialCalc.Formula;var a=f.OperandValueAndType;var g=f.LookupResultType;var k=f.TypeLookupTable.plus;var q=function(A,z){u.push({type:A,value:z})};var e=0;var p="";var l=0;var i=0;var v=0;var c=1;var b;var n;var s,w,r,y;while(j.length>0){m=a(h,j);o=m.type.charAt(0);if(o=="n"){l+=1}if(o!="b"){i+=1}if(o=="b"){v+=1}if(o=="n"){d=m.value-0;e+=d;c*=d;b=(b!=undefined)?(d>b?d:b):d;n=(n!=undefined)?(d<n?d:n):d;if(l==1){r=d;y=0}else{s=r+(d-r)/l;w=y+(d-r)*(d-s);y=w;r=s}p=g(m.type,p||m.type,k)}else{if(o=="e"&&p.charAt(0)!="e"){p=m.type}}}p=p||"n";switch(x){case"SUM":q(p,e);break;case"PRODUCT":q(p,c);break;case"MIN":q(p,n||0);break;case"MAX":q(p,b||0);break;case"COUNT":q("n",l);break;case"COUNTA":q("n",i);break;case"COUNTBLANK":q("n",v);break;case"AVERAGE":if(l>0){q(p,e/l)}else{q("e#DIV/0!",0)}break;case"STDEV":if(l>1){q(p,Math.sqrt(w/(l-1)))}else{q("e#DIV/0!",0)}break;case"STDEVP":if(l>1){q(p,Math.sqrt(w/l))}else{q("e#DIV/0!",0)}break;case"VAR":if(l>1){q(p,w/(l-1))}else{q("e#DIV/0!",0)}break;case"VARP":if(l>1){q(p,w/l)}else{q("e#DIV/0!",0)}break}return null};SocialCalc.Formula.FunctionList.AVERAGE=[SocialCalc.Formula.SeriesFunctions,-1,"vn",null,"stat"];SocialCalc.Formula.FunctionList.COUNT=[SocialCalc.Formula.SeriesFunctions,-1,"vn",null,"stat"];SocialCalc.Formula.FunctionList.COUNTA=[SocialCalc.Formula.SeriesFunctions,-1,"vn",null,"stat"];SocialCalc.Formula.FunctionList.COUNTBLANK=[SocialCalc.Formula.SeriesFunctions,-1,"vn",null,"stat"];SocialCalc.Formula.FunctionList.MAX=[SocialCalc.Formula.SeriesFunctions,-1,"vn",null,"stat"];SocialCalc.Formula.FunctionList.MIN=[SocialCalc.Formula.SeriesFunctions,-1,"vn",null,"stat"];SocialCalc.Formula.FunctionList.PRODUCT=[SocialCalc.Formula.SeriesFunctions,-1,"vn",null,"stat"];SocialCalc.Formula.FunctionList.STDEV=[SocialCalc.Formula.SeriesFunctions,-1,"vn",null,"stat"];SocialCalc.Formula.FunctionList.STDEVP=[SocialCalc.Formula.SeriesFunctions,-1,"vn",null,"stat"];SocialCalc.Formula.FunctionList.SUM=[SocialCalc.Formula.SeriesFunctions,-1,"vn",null,"stat"];SocialCalc.Formula.FunctionList.VAR=[SocialCalc.Formula.SeriesFunctions,-1,"vn",null,"stat"];SocialCalc.Formula.FunctionList.VARP=[SocialCalc.Formula.SeriesFunctions,-1,"vn",null,"stat"];SocialCalc.Formula.DSeriesFunctions=function(w,d,c,s){var G,f,z,a,D,m,I,e;var o,E,Q,P,O,C,K;var F,R,y,J,A;var L;var p=SocialCalc.Formula;var b=p.OperandValueAndType;var T=p.LookupResultType;var r=p.TypeLookupTable.plus;var u=function(j,i){d.push({type:j,value:i})};var G={};var v=0;var N="";var M=0;var g=0;var x=0;var H=1;var B;var h;var n,q,S,l;a=p.TopOfStackValueAndType(s,c);D=p.OperandValueAndType(s,c);m=p.TopOfStackValueAndType(s,c);if(a.type!="range"||m.type!="range"){return p.FunctionArgsError(w,d)}I=p.DecodeRangeParts(s,a.value);e=p.DecodeRangeParts(s,m.value);o=p.FieldToColnum(I.sheetdata,I.col1num,I.ncols,I.row1num,D.value,D.type);if(o<=0){u("e#VALUE!",0);return}E=I.col1num+o-1;K=[];for(Q=0;Q<e.ncols;Q++){C=e.sheetdata.GetAssuredCell(SocialCalc.crToCoord(e.col1num+Q,e.row1num));criterianum=p.FieldToColnum(I.sheetdata,I.col1num,I.ncols,I.row1num,C.datavalue,C.valuetype);if(criterianum<=0){u("e#VALUE!",0);return}K.push(I.col1num+criterianum-1)}for(Q=1;Q<I.nrows;Q++){F=false;CRITERIAROW:for(P=1;P<e.nrows;P++){for(O=0;O<e.ncols;O++){R=SocialCalc.crToCoord(e.col1num+O,e.row1num+P);C=e.sheetdata.GetAssuredCell(R);y=C.datavalue;if(typeof y=="string"&&y.length==0){continue}J=K[O];A=SocialCalc.crToCoord(J,I.row1num+Q);C=e.sheetdata.GetAssuredCell(A);if(!p.TestCriteria(C.datavalue,C.valuetype||"b",y)){continue CRITERIAROW}}F=true;break CRITERIAROW}if(!F){continue}z=SocialCalc.crToCoord(E,I.row1num+Q);C=I.sheetdata.GetAssuredCell(z);G.value=C.datavalue;G.type=C.valuetype;L=G.type.charAt(0);if(L=="n"){M+=1}if(L!="b"){g+=1}if(L=="b"){x+=1}if(L=="n"){v1=G.value-0;v+=v1;H*=v1;B=(B!=undefined)?(v1>B?v1:B):v1;h=(h!=undefined)?(v1<h?v1:h):v1;if(M==1){S=v1;l=0}else{n=S+(v1-S)/M;q=l+(v1-S)*(v1-n);l=q;S=n}N=T(G.type,N||G.type,r)}else{if(L=="e"&&N.charAt(0)!="e"){N=G.type}}}N=N||"n";switch(w){case"DSUM":u(N,v);break;case"DPRODUCT":u(N,H);break;case"DMIN":u(N,h||0);break;case"DMAX":u(N,B||0);break;case"DCOUNT":u("n",M);break;case"DCOUNTA":u("n",g);break;case"DAVERAGE":if(M>0){u(N,v/M)}else{u("e#DIV/0!",0)}break;case"DSTDEV":if(M>1){u(N,Math.sqrt(q/(M-1)))}else{u("e#DIV/0!",0)}break;case"DSTDEVP":if(M>1){u(N,Math.sqrt(q/M))}else{u("e#DIV/0!",0)}break;case"DVAR":if(M>1){u(N,q/(M-1))}else{u("e#DIV/0!",0)}break;case"DVARP":if(M>1){u(N,q/M)}else{u("e#DIV/0!",0)}break;case"DGET":if(M==1){u(N,v)}else{if(M==0){u("e#VALUE!",0)}else{u("e#NUM!",0)}}break}return};SocialCalc.Formula.FunctionList.DAVERAGE=[SocialCalc.Formula.DSeriesFunctions,3,"dfunc","","stat"];SocialCalc.Formula.FunctionList.DCOUNT=[SocialCalc.Formula.DSeriesFunctions,3,"dfunc","","stat"];SocialCalc.Formula.FunctionList.DCOUNTA=[SocialCalc.Formula.DSeriesFunctions,3,"dfunc","","stat"];SocialCalc.Formula.FunctionList.DGET=[SocialCalc.Formula.DSeriesFunctions,3,"dfunc","","stat"];SocialCalc.Formula.FunctionList.DMAX=[SocialCalc.Formula.DSeriesFunctions,3,"dfunc","","stat"];SocialCalc.Formula.FunctionList.DMIN=[SocialCalc.Formula.DSeriesFunctions,3,"dfunc","","stat"];SocialCalc.Formula.FunctionList.DPRODUCT=[SocialCalc.Formula.DSeriesFunctions,3,"dfunc","","stat"];SocialCalc.Formula.FunctionList.DSTDEV=[SocialCalc.Formula.DSeriesFunctions,3,"dfunc","","stat"];SocialCalc.Formula.FunctionList.DSTDEVP=[SocialCalc.Formula.DSeriesFunctions,3,"dfunc","","stat"];SocialCalc.Formula.FunctionList.DSUM=[SocialCalc.Formula.DSeriesFunctions,3,"dfunc","","stat"];SocialCalc.Formula.FunctionList.DVAR=[SocialCalc.Formula.DSeriesFunctions,3,"dfunc","","stat"];SocialCalc.Formula.FunctionList.DVARP=[SocialCalc.Formula.DSeriesFunctions,3,"dfunc","","stat"];SocialCalc.Formula.FieldToColnum=function(g,b,c,e,f,d){var a,i,h;if(d.charAt(0)=="n"){a=f-0;if(a<=0||a>c){return 0}return Math.floor(a)}if(d.charAt(0)!="t"){return 0}f=f?f.toLowerCase():"";for(a=0;a<c;a++){i=g.GetAssuredCell(SocialCalc.crToCoord(b+a,e));h=i.datavalue;h=(h+"").toLowerCase();if(h==f){return a+1}}return 0};SocialCalc.Formula.LookupFunctions=function(B,x,l,h){var m,p,k,w,n,o;var z,q,y,d,v,A,f,b,u,s,j,m;var e=SocialCalc.Formula;var a=e.OperandValueAndType;var g=e.LookupResultType;var i=e.TypeLookupTable.plus;var t=function(r,c){x.push({type:r,value:c})};m=a(h,l);if(typeof m.value=="string"){m.value=m.value.toLowerCase()}p=e.TopOfStackValueAndType(h,l);w=1;if(B=="MATCH"){if(l.length){w=e.OperandAsNumber(h,l);if(w.type.charAt(0)!="n"){t("e#VALUE!",0);return}if(l.length){e.FunctionArgsError(B,x);return 0}w=w.value-0}}else{n=e.OperandAsNumber(h,l);if(n.type.charAt(0)!="n"){t("e#VALUE!",0);return}n=Math.floor(n.value);if(l.length){w=e.OperandAsNumber(h,l);if(w.type.charAt(0)!="n"){t("e#VALUE!",0);return}if(l.length){e.FunctionArgsError(B,x);return 0}w=w.value?1:0}}m.type=m.type.charAt(0);if(m.type=="n"){m.value=m.value-0}if(p.type!="range"){e.FunctionArgsError(B,x);return 0}o=e.DecodeRangeParts(h,p.value,p.type);if(!o){t("e#REF!",0);return}z=0;q=0;y=0;d=0;if(B=="HLOOKUP"){y=1;if(n>o.nrows){t("e#REF!",0);return}}else{if(B=="VLOOKUP"){d=1;if(n>o.ncols){t("e#REF!",0);return}}else{if(B=="MATCH"){if(o.ncols>1){if(o.nrows>1){t("e#N/A",0);return}y=1}else{d=1}}else{e.FunctionArgsError(B,x);return 0}}}if(n<1&&B!="MATCH"){t("e#VALUE!",0);return 0}v;while(1){j=SocialCalc.crToCoord(o.col1num+z,o.row1num+q);b=o.sheetdata.GetAssuredCell(j);u=b.datavalue;s=b.valuetype?b.valuetype.charAt(0):"b";if(s=="n"){u=u-0}if(w){if(m.type=="n"&&s=="n"){if(m.value==u){break}if((w>0&&m.value>u)||(w<0&&m.value<u)){v=1;A=z;f=q}else{if(v){v=2;break}}}else{if(m.type=="t"&&s=="t"){u=typeof u=="string"?u.toLowerCase():"";if(m.value==u){break}if((w>0&&m.value>u)||(w<0&&m.value<u)){v=1;A=z;f=q}else{if(v){v=2;break}}}}}else{if(m.type=="n"&&s=="n"){if(m.value==u){break}}else{if(m.type=="t"&&s=="t"){u=typeof u=="string"?u.toLowerCase():"";if(m.value==u){break}}}}q+=d;z+=y;if(q>=o.nrows||z>=o.ncols){if(v){v=2;break}t("e#N/A",0);return}}if(v==2){q=f;z=A}if(B=="MATCH"){u=z+q+1;s="n"}else{j=SocialCalc.crToCoord(o.col1num+z+(B=="VLOOKUP"?n-1:0),o.row1num+q+(B=="HLOOKUP"?n-1:0));b=o.sheetdata.GetAssuredCell(j);u=b.datavalue;s=b.valuetype}t(s,u);return};SocialCalc.Formula.FunctionList.HLOOKUP=[SocialCalc.Formula.LookupFunctions,-3,"hlookup","","lookup"];SocialCalc.Formula.FunctionList.MATCH=[SocialCalc.Formula.LookupFunctions,-2,"match","","lookup"];SocialCalc.Formula.FunctionList.VLOOKUP=[SocialCalc.Formula.LookupFunctions,-3,"vlookup","","lookup"];SocialCalc.Formula.IndexFunction=function(d,h,e,j){var g,k,i,l,b,m,a;var c=SocialCalc.Formula;var f=function(o,n){h.push({type:o,value:n})};g=c.TopOfStackValueAndType(j,e);if(g.type!="range"){c.FunctionArgsError(d,h);return 0}i=c.DecodeRangeParts(j,g.value,g.type);if(i.sheetname){k="!"+i.sheetname}else{k=""}l={value:0};b={value:0};if(e.length){l=c.OperandAsNumber(j,e);if(l.type.charAt(0)!="n"||l.value<0){f("e#VALUE!",0);return}if(e.length){b=c.OperandAsNumber(j,e);if(b.type.charAt(0)!="n"||b.value<0){f("e#VALUE!",0);return}if(e.length){c.FunctionArgsError(d,h);return 0}}else{if(i.nrows==1){b.value=l.value;l.value=0}}}if(l.value>i.nrows||b.value>i.ncols){f("e#REF!",0);return}if(l.value==0){if(b.value==0){if(i.nrows==1&&i.ncols==1){m=SocialCalc.crToCoord(i.col1num,i.row1num)+k;a="coord"}else{m=SocialCalc.crToCoord(i.col1num,i.row1num)+k+"|"+SocialCalc.crToCoord(i.col1num+i.ncols-1,i.row1num+i.nrows-1)+"|";a="range"}}else{if(i.nrows==1){m=SocialCalc.crToCoord(i.col1num+b.value-1,i.row1num)+k;a="coord"}else{m=SocialCalc.crToCoord(i.col1num+b.value-1,i.row1num)+k+"|"+SocialCalc.crToCoord(i.col1num+b.value-1,i.row1num+i.nrows-1)+"|";a="range"}}}else{if(b.value==0){if(i.ncols==1){m=SocialCalc.crToCoord(i.col1num,i.row1num+l.value-1)+k;a="coord"}else{m=SocialCalc.crToCoord(i.col1num,i.row1num+l.value-1)+k+"|"+SocialCalc.crToCoord(i.col1num+i.ncols-1,i.row1num+l.value-1)+"|";a="range"}}else{m=SocialCalc.crToCoord(i.col1num+b.value-1,i.row1num+l.value-1)+k;a="coord"}}f(a,m);return};SocialCalc.Formula.FunctionList.INDEX=[SocialCalc.Formula.IndexFunction,-1,"index","","lookup"];SocialCalc.Formula.CountifSumifFunctions=function(t,s,i,f){var q,j,h,l,m,b,o,n;var c=0;var p="";var k=0;var d=SocialCalc.Formula;var a=d.OperandValueAndType;var e=d.LookupResultType;var g=d.TypeLookupTable.plus;var r=function(w,u){s.push({type:w,value:u})};q=d.TopOfStackValueAndType(f,i);j=d.OperandAsText(f,i);if(t=="SUMIF"){if(i.length==1){h=d.TopOfStackValueAndType(f,i)}else{if(i.length==0){h={value:q.value,type:q.type}}else{d.FunctionArgsError(t,s);return 0}}}else{h={value:q.value,type:q.type}}if(j.type.charAt(0)=="n"){j.value=j.value+""}else{if(j.type.charAt(0)=="e"){j.value=null}else{if(j.type.charAt(0)=="b"){j.value=null}}}if(q.type!="coord"&&q.type!="range"){d.FunctionArgsError(t,s);return 0}if(t=="SUMIF"&&h.type!="coord"&&h.type!="range"){d.FunctionArgsError(t,s);return 0}i.push(q);l=[];l.push(h);while(i.length){o=a(f,i);n=a(f,l);if(!d.TestCriteria(o.value,o.type,j.value)){continue}k+=1;if(n.type.charAt(0)=="n"){c+=n.value-0;p=e(n.type,p||n.type,g)}else{if(n.type.charAt(0)=="e"&&p.charAt(0)!="e"){p=n.type}}}p=p||"n";if(t=="SUMIF"){r(p,c)}else{if(t=="COUNTIF"){r("n",k)}}return};SocialCalc.Formula.FunctionList.COUNTIF=[SocialCalc.Formula.CountifSumifFunctions,2,"rangec","","stat"];SocialCalc.Formula.FunctionList.SUMIF=[SocialCalc.Formula.CountifSumifFunctions,-2,"sumif","","stat"];SocialCalc.Formula.IfFunction=function(f,a,e,c){var d,b;d=SocialCalc.Formula.OperandValueAndType(c,e);b=d.type.charAt(0);if(b!="n"&&b!="b"){a.push({type:"e#VALUE!",value:0});return}if(!d.value){e.pop()}a.push(e.pop());if(d.value){e.pop()}return null};SocialCalc.Formula.FunctionList.IF=[SocialCalc.Formula.IfFunction,3,"iffunc","","test"];SocialCalc.Formula.DateFunction=function(c,e,d,g){var b=SocialCalc.Formula;var j=0;var h=b.OperandAsNumber(g,d);var f=b.OperandAsNumber(g,d);var i=b.OperandAsNumber(g,d);var a=b.LookupResultType(h.type,f.type,b.TypeLookupTable.twoargnumeric);a=b.LookupResultType(a,i.type,b.TypeLookupTable.twoargnumeric);if(a.charAt(0)=="n"){j=SocialCalc.FormatNumber.convert_date_gregorian_to_julian(Math.floor(h.value),Math.floor(f.value),Math.floor(i.value))-SocialCalc.FormatNumber.datevalues.julian_offset;a="nd"}b.PushOperand(e,a,j);return};SocialCalc.Formula.FunctionList.DATE=[SocialCalc.Formula.DateFunction,3,"date","","datetime"];SocialCalc.Formula.TimeFunction=function(c,f,d,g){var b=SocialCalc.Formula;var j=0;var h=b.OperandAsNumber(g,d);var e=b.OperandAsNumber(g,d);var i=b.OperandAsNumber(g,d);var a=b.LookupResultType(h.type,e.type,b.TypeLookupTable.twoargnumeric);a=b.LookupResultType(a,i.type,b.TypeLookupTable.twoargnumeric);if(a.charAt(0)=="n"){j=((h.value*60*60)+(e.value*60)+i.value)/(24*60*60);a="nt"}b.PushOperand(f,a,j);return};SocialCalc.Formula.FunctionList.TIME=[SocialCalc.Formula.TimeFunction,3,"hms","","datetime"];SocialCalc.Formula.DMYFunctions=function(d,h,e,i){var b,k,g;var c=SocialCalc.Formula;var j=0;var f=c.OperandAsNumber(i,e);var a=c.LookupResultType(f.type,f.type,c.TypeLookupTable.oneargnumeric);if(a.charAt(0)=="n"){b=SocialCalc.FormatNumber.convert_date_julian_to_gregorian(Math.floor(f.value+SocialCalc.FormatNumber.datevalues.julian_offset));switch(d){case"DAY":j=b.day;break;case"MONTH":j=b.month;break;case"YEAR":j=b.year;break;case"WEEKDAY":k={value:1};if(e.length){k=c.OperandAsNumber(i,e);if(k.type.charAt(0)!="n"||k.value<1||k.value>3){c.PushOperand(h,"e#VALUE!",0);return}if(e.length){c.FunctionArgsError(d,h);return}}g=6;if(k.value>1){g-=1}j=Math.floor(f.value+g)%7+(k.value<3?1:0);break}}c.PushOperand(h,a,j);return};SocialCalc.Formula.FunctionList.DAY=[SocialCalc.Formula.DMYFunctions,1,"v","","datetime"];SocialCalc.Formula.FunctionList.MONTH=[SocialCalc.Formula.DMYFunctions,1,"v","","datetime"];SocialCalc.Formula.FunctionList.YEAR=[SocialCalc.Formula.DMYFunctions,1,"v","","datetime"];SocialCalc.Formula.FunctionList.WEEKDAY=[SocialCalc.Formula.DMYFunctions,-1,"weekday","","datetime"];SocialCalc.Formula.HMSFunctions=function(c,f,d,h){var i,e,j,k;var b=SocialCalc.Formula;var l=0;var g=b.OperandAsNumber(h,d);var a=b.LookupResultType(g.type,g.type,b.TypeLookupTable.oneargnumeric);if(a.charAt(0)=="n"){if(g.value<0){b.PushOperand(f,"e#NUM!",0);return}k=g.value-Math.floor(g.value);k*=24;i=Math.floor(k);k-=Math.floor(k);k*=60;e=Math.floor(k);k-=Math.floor(k);k*=60;j=Math.floor(k+(g.value>=0?0.5:-0.5));if(c=="HOUR"){l=i}else{if(c=="MINUTE"){l=e}else{if(c=="SECOND"){l=j}}}}b.PushOperand(f,a,l);return};SocialCalc.Formula.FunctionList.HOUR=[SocialCalc.Formula.HMSFunctions,1,"v","","datetime"];SocialCalc.Formula.FunctionList.MINUTE=[SocialCalc.Formula.HMSFunctions,1,"v","","datetime"];SocialCalc.Formula.FunctionList.SECOND=[SocialCalc.Formula.HMSFunctions,1,"v","","datetime"];SocialCalc.Formula.ExactFunction=function(c,f,d,h){var b=SocialCalc.Formula;var k=0;var a="nl";var j=b.OperandValueAndType(h,d);var g=j.type.charAt(0);var i=b.OperandValueAndType(h,d);var e=i.type.charAt(0);if(g=="t"){if(e=="t"){k=j.value==i.value?1:0}else{if(e=="b"){k=j.value.length?0:1}else{if(e=="n"){k=j.value==i.value+""?1:0}else{if(e=="e"){k=i.value;a=i.type}else{k=0}}}}}else{if(g=="n"){if(e=="n"){k=j.value-0==i.value-0?1:0}else{if(e=="b"){k=0}else{if(e=="t"){k=j.value+""==i.value?1:0}else{if(e=="e"){k=i.value;a=i.type}else{k=0}}}}}else{if(g=="b"){if(e=="t"){k=i.value.length?0:1}else{if(e=="b"){k=1}else{if(e=="n"){k=0}else{if(e=="e"){k=i.value;a=i.type}else{k=0}}}}}else{if(g=="e"){k=j.value;a=j.type}}}}b.PushOperand(f,a,k);return};SocialCalc.Formula.FunctionList.EXACT=[SocialCalc.Formula.ExactFunction,2,"","","text"];SocialCalc.Formula.ArgList={FIND:[1,1,0],LEFT:[1,0],LEN:[1],LOWER:[1],MID:[1,0,0],PROPER:[1],REPLACE:[1,0,0,1],REPT:[1,0],RIGHT:[1,0],SUBSTITUTE:[1,1,1,0],TRIM:[1],UPPER:[1]};SocialCalc.Formula.StringFunctions=function(f,l,g,n){var j,o,h,m,c,k;var b=SocialCalc.Formula;var r=0;var a="e#VALUE!";var p=g.length;var e=b.ArgList[f];var q=[];var d=[];for(j=1;j<=p;j++){if(j>e.length){b.FunctionArgsError(f,l);return}if(e[j-1]==0){o=b.OperandAsNumber(n,g)}else{if(e[j-1]==1){o=b.OperandAsText(n,g)}else{if(e[j-1]==-1){o=b.OperandValueAndType(n,g)}}}q[j]=o.value;d[j]=o.type;if(o.type.charAt(0)=="e"){b.PushOperand(l,o.type,r);return}}switch(f){case"FIND":h=d[3]?q[3]-1:0;if(h<0){r="Start is before string"}else{r=q[2].indexOf(q[1],h);if(r>=0){r+=1;a="n"}else{r="Not found"}}break;case"LEFT":m=d[2]?q[2]-0:1;if(m<0){r="Negative length"}else{r=q[1].substring(0,m);a="t"}break;case"LEN":r=q[1].length;a="n";break;case"LOWER":r=q[1].toLowerCase();a="t";break;case"MID":c=q[2]-0;m=q[3]-0;if(m<1||c<1){r="Bad arguments"}else{r=q[1].substring(c-1,c+m-1);a="t"}break;case"PROPER":r=q[1].replace(/\b\w+\b/g,function(i){return i.substring(0,1).toUpperCase()+i.substring(1)});a="t";break;case"REPLACE":c=q[2]-0;m=q[3]-0;if(m<0||c<1){r="Bad arguments"}else{r=q[1].substring(0,c-1)+q[4]+q[1].substring(c-1+m);a="t"}break;case"REPT":k=q[2]-0;if(k<0){r="Negative count"}else{r="";for(;k>0;k--){r+=q[1]}a="t"}break;case"RIGHT":m=d[2]?q[2]-0:1;if(m<0){r="Negative length"}else{r=q[1].slice(-m);a="t"}break;case"SUBSTITUTE":fulltext=q[1];oldtext=q[2];newtext=q[3];if(q[4]!=null){which=q[4]-0;if(which<=0){r="Non-positive instance number";break}}else{which=0}k=0;oldpos=0;r="";while(true){pos=fulltext.indexOf(oldtext,oldpos);if(pos>=0){k++;r+=fulltext.substring(oldpos,pos);if(which==0){r+=newtext}else{if(which==k){r+=newtext+fulltext.substring(pos+oldtext.length);break}else{r+=oldtext}}oldpos=pos+oldtext.length}else{r+=fulltext.substring(oldpos);break}}a="t";break;case"TRIM":r=q[1];r=r.replace(/^ */,"");r=r.replace(/ *$/,"");r=r.replace(/ +/g," ");a="t";break;case"UPPER":r=q[1].toUpperCase();a="t";break}b.PushOperand(l,a,r);return};SocialCalc.Formula.FunctionList.FIND=[SocialCalc.Formula.StringFunctions,-2,"find","","text"];SocialCalc.Formula.FunctionList.LEFT=[SocialCalc.Formula.StringFunctions,-2,"tc","","text"];SocialCalc.Formula.FunctionList.LEN=[SocialCalc.Formula.StringFunctions,1,"txt","","text"];SocialCalc.Formula.FunctionList.LOWER=[SocialCalc.Formula.StringFunctions,1,"txt","","text"];SocialCalc.Formula.FunctionList.MID=[SocialCalc.Formula.StringFunctions,3,"mid","","text"];SocialCalc.Formula.FunctionList.PROPER=[SocialCalc.Formula.StringFunctions,1,"v","","text"];SocialCalc.Formula.FunctionList.REPLACE=[SocialCalc.Formula.StringFunctions,4,"replace","","text"];SocialCalc.Formula.FunctionList.REPT=[SocialCalc.Formula.StringFunctions,2,"tc","","text"];SocialCalc.Formula.FunctionList.RIGHT=[SocialCalc.Formula.StringFunctions,-1,"tc","","text"];SocialCalc.Formula.FunctionList.SUBSTITUTE=[SocialCalc.Formula.StringFunctions,-3,"subs","","text"];SocialCalc.Formula.FunctionList.TRIM=[SocialCalc.Formula.StringFunctions,1,"v","","text"];SocialCalc.Formula.FunctionList.UPPER=[SocialCalc.Formula.StringFunctions,1,"v","","text"];SocialCalc.Formula.IsFunctions=function(c,e,d,f){var b=SocialCalc.Formula;var i=0;var a="nl";var g=b.OperandValueAndType(f,d);var h=g.type.charAt(0);switch(c){case"ISBLANK":i=g.type=="b"?1:0;break;case"ISERR":i=h=="e"?(g.type=="e#N/A"?0:1):0;break;case"ISERROR":i=h=="e"?1:0;break;case"ISLOGICAL":i=g.type=="nl"?1:0;break;case"ISNA":i=g.type=="e#N/A"?1:0;break;case"ISNONTEXT":i=h=="t"?0:1;break;case"ISNUMBER":i=h=="n"?1:0;break;case"ISTEXT":i=h=="t"?1:0;break}b.PushOperand(e,a,i);return};SocialCalc.Formula.FunctionList.ISBLANK=[SocialCalc.Formula.IsFunctions,1,"v","","test"];SocialCalc.Formula.FunctionList.ISERR=[SocialCalc.Formula.IsFunctions,1,"v","","test"];SocialCalc.Formula.FunctionList.ISERROR=[SocialCalc.Formula.IsFunctions,1,"v","","test"];SocialCalc.Formula.FunctionList.ISLOGICAL=[SocialCalc.Formula.IsFunctions,1,"v","","test"];SocialCalc.Formula.FunctionList.ISNA=[SocialCalc.Formula.IsFunctions,1,"v","","test"];SocialCalc.Formula.FunctionList.ISNONTEXT=[SocialCalc.Formula.IsFunctions,1,"v","","test"];SocialCalc.Formula.FunctionList.ISNUMBER=[SocialCalc.Formula.IsFunctions,1,"v","","test"];SocialCalc.Formula.FunctionList.ISTEXT=[SocialCalc.Formula.IsFunctions,1,"v","","test"];SocialCalc.Formula.NTVFunctions=function(c,e,d,f){var b=SocialCalc.Formula;var i=0;var a="e#VALUE!";var g=b.OperandValueAndType(f,d);var h=g.type.charAt(0);switch(c){case"N":i=h=="n"?g.value-0:0;a="n";break;case"T":i=h=="t"?g.value+"":"";a="t";break;case"VALUE":if(h=="n"||h=="b"){i=g.value||0;a="n"}else{if(h=="t"){g=SocialCalc.DetermineValueType(g.value);if(g.type.charAt(0)!="n"){i=0;a="e#VALUE!"}else{i=g.value-0;a="n"}}}break}if(h=="e"){a=g.type}b.PushOperand(e,a,i);return};SocialCalc.Formula.FunctionList.N=[SocialCalc.Formula.NTVFunctions,1,"v","","math"];SocialCalc.Formula.FunctionList.T=[SocialCalc.Formula.NTVFunctions,1,"v","","text"];SocialCalc.Formula.FunctionList.VALUE=[SocialCalc.Formula.NTVFunctions,1,"v","","text"];SocialCalc.Formula.Math1Functions=function(b,e,c,g){var h,i,d;var j={};var a=SocialCalc.Formula;h=a.OperandAsNumber(g,c);i=h.value;j.type=a.LookupResultType(h.type,h.type,a.TypeLookupTable.oneargnumeric);if(j.type=="n"){switch(b){case"ABS":i=Math.abs(i);break;case"ACOS":if(i>=-1&&i<=1){i=Math.acos(i)}else{j.type="e#NUM!"}break;case"ASIN":if(i>=-1&&i<=1){i=Math.asin(i)}else{j.type="e#NUM!"}break;case"ATAN":i=Math.atan(i);break;case"COS":i=Math.cos(i);break;case"DEGREES":i=i*180/Math.PI;break;case"EVEN":i=i<0?-i:i;if(i!=Math.floor(i)){i=Math.floor(i+1)+(Math.floor(i+1)%2)}else{i=i+(i%2)}if(h.value<0){i=-i}break;case"EXP":i=Math.exp(i);break;case"FACT":d=1;i=Math.floor(i);for(;i>0;i--){d*=i}i=d;break;case"INT":i=Math.floor(i);break;case"LN":if(i<=0){j.type="e#NUM!";j.error=SocialCalc.Constants.s_sheetfunclnarg}i=Math.log(i);break;case"LOG10":if(i<=0){j.type="e#NUM!";j.error=SocialCalc.Constants.s_sheetfunclog10arg}i=Math.log(i)/Math.log(10);break;case"ODD":i=i<0?-i:i;if(i!=Math.floor(i)){i=Math.floor(i+1)+(1-(Math.floor(i+1)%2))}else{i=i+(1-(i%2))}if(h.value<0){i=-i}break;case"RADIANS":i=i*Math.PI/180;break;case"SIN":i=Math.sin(i);break;case"SQRT":if(i>=0){i=Math.sqrt(i)}else{j.type="e#NUM!"}break;case"TAN":if(Math.cos(i)!=0){i=Math.tan(i)}else{j.type="e#NUM!"}break}}j.value=i;e.push(j);return null};SocialCalc.Formula.FunctionList.ABS=[SocialCalc.Formula.Math1Functions,1,"v","","math"];SocialCalc.Formula.FunctionList.ACOS=[SocialCalc.Formula.Math1Functions,1,"v","","math"];SocialCalc.Formula.FunctionList.ASIN=[SocialCalc.Formula.Math1Functions,1,"v","","math"];SocialCalc.Formula.FunctionList.ATAN=[SocialCalc.Formula.Math1Functions,1,"v","","math"];SocialCalc.Formula.FunctionList.COS=[SocialCalc.Formula.Math1Functions,1,"v","","math"];SocialCalc.Formula.FunctionList.DEGREES=[SocialCalc.Formula.Math1Functions,1,"v","","math"];SocialCalc.Formula.FunctionList.EVEN=[SocialCalc.Formula.Math1Functions,1,"v","","math"];SocialCalc.Formula.FunctionList.EXP=[SocialCalc.Formula.Math1Functions,1,"v","","math"];SocialCalc.Formula.FunctionList.FACT=[SocialCalc.Formula.Math1Functions,1,"v","","math"];SocialCalc.Formula.FunctionList.INT=[SocialCalc.Formula.Math1Functions,1,"v","","math"];SocialCalc.Formula.FunctionList.LN=[SocialCalc.Formula.Math1Functions,1,"v","","math"];SocialCalc.Formula.FunctionList.LOG10=[SocialCalc.Formula.Math1Functions,1,"v","","math"];SocialCalc.Formula.FunctionList.ODD=[SocialCalc.Formula.Math1Functions,1,"v","","math"];SocialCalc.Formula.FunctionList.RADIANS=[SocialCalc.Formula.Math1Functions,1,"v","","math"];SocialCalc.Formula.FunctionList.SIN=[SocialCalc.Formula.Math1Functions,1,"v","","math"];SocialCalc.Formula.FunctionList.SQRT=[SocialCalc.Formula.Math1Functions,1,"v","","math"];SocialCalc.Formula.FunctionList.TAN=[SocialCalc.Formula.Math1Functions,1,"v","","math"];SocialCalc.Formula.Math2Functions=function(b,f,c,h){var l,g,k,d,j,e;var m={};var a=SocialCalc.Formula;l=a.OperandAsNumber(h,c);g=a.OperandAsNumber(h,c);k=0;m.type=a.LookupResultType(l.type,g.type,a.TypeLookupTable.twoargnumeric);if(m.type=="n"){switch(b){case"ATAN2":if(l.value==0&&g.value==0){m.type="e#DIV/0!"}else{m.value=Math.atan2(g.value,l.value)}break;case"POWER":m.value=Math.pow(l.value,g.value);if(isNaN(m.value)){m.value=0;m.type="e#NUM!"}break;case"MOD":if(g.value==0){m.type="e#DIV/0!"}else{d=l.value/g.value;d=Math.floor(d);m.value=l.value-(d*g.value)}break;case"TRUNC":j=1;if(g.value>=0){g.value=Math.floor(g.value);for(e=0;e<g.value;e++){j*=10}m.value=Math.floor(Math.abs(l.value)*j)/j}else{if(g.value<0){g.value=Math.floor(-g.value);for(e=0;e<g.value;e++){j*=10}m.value=Math.floor(Math.abs(l.value)/j)*j}}if(l.value<0){m.value=-m.value}}}f.push(m);return null};SocialCalc.Formula.FunctionList.ATAN2=[SocialCalc.Formula.Math2Functions,2,"xy","","math"];SocialCalc.Formula.FunctionList.MOD=[SocialCalc.Formula.Math2Functions,2,"","","math"];SocialCalc.Formula.FunctionList.POWER=[SocialCalc.Formula.Math2Functions,2,"","","math"];SocialCalc.Formula.FunctionList.TRUNC=[SocialCalc.Formula.Math2Functions,2,"valpre","","math"];SocialCalc.Formula.LogFunction=function(h,c,f,d){var e,b;var a={};var g=SocialCalc.Formula;a.value=0;e=g.OperandAsNumber(d,f);a.type=g.LookupResultType(e.type,e.type,g.TypeLookupTable.oneargnumeric);if(f.length==1){b=g.OperandAsNumber(d,f);if(b.type.charAt(0)!="n"||b.value<=0){g.FunctionSpecificError(h,c,"e#NUM!",SocialCalc.Constants.s_sheetfunclogsecondarg);return 0}}else{if(f.length!=0){g.FunctionArgsError(h,c);return 0}else{b={value:Math.E,type:"n"}}}if(a.type=="n"){if(e.value<=0){g.FunctionSpecificError(h,c,"e#NUM!",SocialCalc.Constants.s_sheetfunclogfirstarg);return 0}a.value=Math.log(e.value)/Math.log(b.value)}c.push(a);return};SocialCalc.Formula.FunctionList.LOG=[SocialCalc.Formula.LogFunction,-1,"log","","math"];SocialCalc.Formula.RoundFunction=function(c,g,d,h){var j,k,e,f;var b=SocialCalc.Formula;var m=0;var a="e#VALUE!";var l=b.OperandValueAndType(h,d);var a=b.LookupResultType(l.type,l.type,b.TypeLookupTable.oneargnumeric);if(d.length==1){j=b.OperandValueAndType(h,d);if(j.type.charAt(0)!="n"){b.FunctionSpecificError(c,g,"e#NUM!",SocialCalc.Constants.s_sheetfuncroundsecondarg);return 0}}else{if(d.length!=0){b.FunctionArgsError(c,g);return 0}else{j={value:0,type:"n"}}}if(a=="n"){j.value=j.value-0;if(j.value==0){m=Math.round(l.value)}else{if(j.value>0){k=1;j.value=Math.floor(j.value);for(f=0;f<j.value;f++){k*=10}e=Math.round(l.value*k);m=e/k}else{if(j.value<0){k=1;j.value=Math.floor(-j.value);for(f=0;f<j.value;f++){k*=10}e=Math.round(l.value/k);m=e*k}}}}b.PushOperand(g,a,m);return};SocialCalc.Formula.FunctionList.ROUND=[SocialCalc.Formula.RoundFunction,-1,"vp","","math"];SocialCalc.Formula.AndOrFunctions=function(h,b,f,e){var c,a;var g=SocialCalc.Formula;var d="";if(h=="AND"){a=1}else{if(h=="OR"){a=0}}while(f.length){c=g.OperandValueAndType(e,f);if(c.type.charAt(0)=="n"){c.value=c.value-0;if(h=="AND"){a=c.value!=0?a:0}else{if(h=="OR"){a=c.value!=0?1:a}}d=g.LookupResultType(c.type,d||"nl",g.TypeLookupTable.propagateerror)}else{if(c.type.charAt(0)=="e"&&d.charAt(0)!="e"){d=c.type}}}if(d.length<1){d="e#VALUE!";a=0}g.PushOperand(b,d,a);return};SocialCalc.Formula.FunctionList.AND=[SocialCalc.Formula.AndOrFunctions,-1,"vn","","test"];SocialCalc.Formula.FunctionList.OR=[SocialCalc.Formula.AndOrFunctions,-1,"vn","","test"];SocialCalc.Formula.NotFunction=function(h,b,f,d){var a=0;var g=SocialCalc.Formula;var e=g.OperandValueAndType(d,f);var c=g.LookupResultType(e.type,e.type,g.TypeLookupTable.propagateerror);if(e.type.charAt(0)=="n"||e.type=="b"){a=e.value-0!=0?0:1;c="nl"}else{if(e.type.charAt(0)=="t"){c="e#VALUE!"}}g.PushOperand(b,c,a);return};SocialCalc.Formula.FunctionList.NOT=[SocialCalc.Formula.NotFunction,1,"v","","test"];SocialCalc.Formula.ChooseFunction=function(c,f,d,g){var a,e,h;var j=0;var b=SocialCalc.Formula;var i=b.OperandAsNumber(g,d);if(i.type.charAt(0)!="n"){i.value=0}i.value=Math.floor(i.value);e=0;while(d.length){h=b.TopOfStackValueAndType(g,d);e+=1;if(i.value==e){j=h.value;a=h.type;break}}if(a){b.PushOperand(f,a,j)}else{b.PushOperand(f,"e#VALUE!",0)}return};SocialCalc.Formula.FunctionList.CHOOSE=[SocialCalc.Formula.ChooseFunction,-2,"choose","","lookup"];SocialCalc.Formula.ColumnsRowsFunctions=function(c,f,d,g){var a,e;var i=0;var b=SocialCalc.Formula;var h=b.TopOfStackValueAndType(g,d);if(h.type=="coord"){i=1;a="n"}else{if(h.type=="range"){e=b.DecodeRangeParts(g,h.value);if(c=="COLUMNS"){i=e.ncols}else{if(c=="ROWS"){i=e.nrows}}a="n"}else{i=0;a="e#VALUE!"}}b.PushOperand(f,a,i);return};SocialCalc.Formula.FunctionList.COLUMNS=[SocialCalc.Formula.ColumnsRowsFunctions,1,"range","","lookup"];SocialCalc.Formula.FunctionList.ROWS=[SocialCalc.Formula.ColumnsRowsFunctions,1,"range","","lookup"];SocialCalc.Formula.ZeroArgFunctions=function(c,f,d,g){var a,h,i,e,b;var j={value:0};switch(c){case"FALSE":j.type="nl";j.value=0;break;case"NA":j.type="e#N/A";break;case"NOW":a=new Date();h=a.getTimezoneOffset();a=a.getTime()/1000;i=25569;e=24*60*60;b=i+a/e-h/(24*60);j.value=b;j.type="ndt";SocialCalc.Formula.FreshnessInfo.volatiles.NOW=true;break;case"PI":j.type="n";j.value=Math.PI;break;case"TODAY":a=new Date();h=a.getTimezoneOffset();a=a.getTime()/1000;i=25569;e=24*60*60;b=i+a/e-h/(24*60);j.value=Math.floor(b);j.type="nd";SocialCalc.Formula.FreshnessInfo.volatiles.TODAY=true;break;case"TRUE":j.type="nl";j.value=1;break}f.push(j);return null};SocialCalc.Formula.FunctionList.FALSE=[SocialCalc.Formula.ZeroArgFunctions,0,"","","test"];SocialCalc.Formula.FunctionList.NA=[SocialCalc.Formula.ZeroArgFunctions,0,"","","test"];SocialCalc.Formula.FunctionList.NOW=[SocialCalc.Formula.ZeroArgFunctions,0,"","","datetime"];SocialCalc.Formula.FunctionList.PI=[SocialCalc.Formula.ZeroArgFunctions,0,"","","math"];SocialCalc.Formula.FunctionList.TODAY=[SocialCalc.Formula.ZeroArgFunctions,0,"","","datetime"];SocialCalc.Formula.FunctionList.TRUE=[SocialCalc.Formula.ZeroArgFunctions,0,"","","test"];SocialCalc.Formula.DDBFunction=function(c,j,f,k){var a,n,e,h;var b=SocialCalc.Formula;var d=b.OperandAsNumber(k,f);var m=b.OperandAsNumber(k,f);var g=b.OperandAsNumber(k,f);var l=b.OperandAsNumber(k,f);if(b.CheckForErrorValue(j,d)){return}if(b.CheckForErrorValue(j,m)){return}if(b.CheckForErrorValue(j,g)){return}if(b.CheckForErrorValue(j,l)){return}if(g.value<1){b.FunctionSpecificError(c,j,"e#NUM!",SocialCalc.Constants.s_sheetfuncddblife);return 0}a={value:2,type:"n"};if(f.length>0){a=b.OperandAsNumber(k,f)}if(f.length!=0){b.FunctionArgsError(c,j);return 0}if(b.CheckForErrorValue(j,a)){return}n=0;e=0;for(h=1;h<=l.value-0&&h<=g.value;h++){n=(d.value-e)*(a.value/g.value);if(d.value-e-n<m.value){n=d.value-e-m.value}e+=n}b.PushOperand(j,"n$",n);return};SocialCalc.Formula.FunctionList.DDB=[SocialCalc.Formula.DDBFunction,-4,"ddb","","financial"];SocialCalc.Formula.SLNFunction=function(b,f,d,g){var i;var a=SocialCalc.Formula;var c=a.OperandAsNumber(g,d);var h=a.OperandAsNumber(g,d);var e=a.OperandAsNumber(g,d);if(a.CheckForErrorValue(f,c)){return}if(a.CheckForErrorValue(f,h)){return}if(a.CheckForErrorValue(f,e)){return}if(e.value<1){a.FunctionSpecificError(b,f,"e#NUM!",SocialCalc.Constants.s_sheetfuncslnlife);return 0}i=(c.value-h.value)/e.value;a.PushOperand(f,"n$",i);return};SocialCalc.Formula.FunctionList.SLN=[SocialCalc.Formula.SLNFunction,3,"csl","","financial"];SocialCalc.Formula.SYDFunction=function(c,g,e,h){var k,b;var a=SocialCalc.Formula;var d=a.OperandAsNumber(h,e);var j=a.OperandAsNumber(h,e);var f=a.OperandAsNumber(h,e);var i=a.OperandAsNumber(h,e);if(a.CheckForErrorValue(g,d)){return}if(a.CheckForErrorValue(g,j)){return}if(a.CheckForErrorValue(g,f)){return}if(a.CheckForErrorValue(g,i)){return}if(f.value<1||i.value<=0){a.PushOperand(g,"e#NUM!",0);return 0}b=((f.value+1)*f.value)/2;k=(d.value-j.value)*(f.value-i.value+1)/b;a.PushOperand(g,"n$",k);return};SocialCalc.Formula.FunctionList.SYD=[SocialCalc.Formula.SYDFunction,4,"cslp","","financial"];SocialCalc.Formula.InterestFunctions=function(fname,operand,foperand,sheet){var resulttype,result,dval,eval,fval;var pv,fv,rate,n,payment,paytype,guess,part1,part2,part3,part4,part5;var olddelta,maxloop,tries,deltaepsilon,rate,oldrate,m;var scf=SocialCalc.Formula;var aval=scf.OperandAsNumber(sheet,foperand);var bval=scf.OperandAsNumber(sheet,foperand);var cval=scf.OperandAsNumber(sheet,foperand);resulttype=scf.LookupResultType(aval.type,bval.type,scf.TypeLookupTable.twoargnumeric);resulttype=scf.LookupResultType(resulttype,cval.type,scf.TypeLookupTable.twoargnumeric);if(foperand.length){dval=scf.OperandAsNumber(sheet,foperand);resulttype=scf.LookupResultType(resulttype,dval.type,scf.TypeLookupTable.twoargnumeric);if(foperand.length){eval=scf.OperandAsNumber(sheet,foperand);resulttype=scf.LookupResultType(resulttype,eval.type,scf.TypeLookupTable.twoargnumeric);if(foperand.length){if(fname!="RATE"){scf.FunctionArgsError(fname,operand);return 0}fval=scf.OperandAsNumber(sheet,foperand);resulttype=scf.LookupResultType(resulttype,fval.type,scf.TypeLookupTable.twoargnumeric)}}}if(resulttype=="n"){switch(fname){case"FV":rate=aval.value;n=bval.value;payment=cval.value;pv=dval!=null?dval.value:0;paytype=eval!=null?(eval.value?1:0):0;if(rate==0){fv=-pv-(payment*n)}else{fv=-(pv*Math.pow(1+rate,n)+payment*(1+rate*paytype)*(Math.pow(1+rate,n)-1)/rate)}result=fv;resulttype="n$";break;case"NPER":rate=aval.value;payment=bval.value;pv=cval.value;fv=dval!=null?dval.value:0;paytype=eval!=null?(eval.value?1:0):0;if(rate==0){if(payment==0){scf.PushOperand(operand,"e#NUM!",0);return}n=(pv+fv)/(-payment)}else{part1=payment*(1+rate*paytype)/rate;part2=pv+part1;if(part2==0||rate<=-1){scf.PushOperand(operand,"e#NUM!",0);return}part3=(part1-fv)/part2;if(part3<=0){scf.PushOperand(operand,"e#NUM!",0);return}part4=Math.log(part3);part5=Math.log(1+rate);n=part4/part5}result=n;resulttype="n";break;case"PMT":rate=aval.value;n=bval.value;pv=cval.value;fv=dval!=null?dval.value:0;paytype=eval!=null?(eval.value?1:0):0;if(n==0){scf.PushOperand(operand,"e#NUM!",0);return}else{if(rate==0){payment=(fv-pv)/n}else{payment=(0-fv-pv*Math.pow(1+rate,n))/((1+rate*paytype)*(Math.pow(1+rate,n)-1)/rate)}}result=payment;resulttype="n$";break;case"PV":rate=aval.value;n=bval.value;payment=cval.value;fv=dval!=null?dval.value:0;paytype=eval!=null?(eval.value?1:0):0;if(rate==-1){scf.PushOperand(operand,"e#DIV/0!",0);return}else{if(rate==0){pv=-fv-(payment*n)}else{pv=(-fv-payment*(1+rate*paytype)*(Math.pow(1+rate,n)-1)/rate)/(Math.pow(1+rate,n))}}result=pv;resulttype="n$";break;case"RATE":n=aval.value;payment=bval.value;pv=cval.value;fv=dval!=null?dval.value:0;paytype=eval!=null?(eval.value?1:0):0;guess=fval!=null?fval.value:0.1;maxloop=100;tries=0;delta=1;epsilon=1e-7;rate=guess||1e-8;while((delta>=0?delta:-delta)>epsilon&&(rate!=oldrate)){delta=fv+pv*Math.pow(1+rate,n)+payment*(1+rate*paytype)*(Math.pow(1+rate,n)-1)/rate;if(olddelta!=null){m=(delta-olddelta)/(rate-oldrate)||0.001;oldrate=rate;rate=rate-delta/m;olddelta=delta}else{oldrate=rate;rate=1.1*rate;olddelta=delta}tries++;if(tries>=maxloop){scf.PushOperand(operand,"e#NUM!",0);return}}result=rate;resulttype="n%";break}}scf.PushOperand(operand,resulttype,result);return};SocialCalc.Formula.FunctionList.FV=[SocialCalc.Formula.InterestFunctions,-3,"fv","","financial"];SocialCalc.Formula.FunctionList.NPER=[SocialCalc.Formula.InterestFunctions,-3,"nper","","financial"];SocialCalc.Formula.FunctionList.PMT=[SocialCalc.Formula.InterestFunctions,-3,"pmt","","financial"];SocialCalc.Formula.FunctionList.PV=[SocialCalc.Formula.InterestFunctions,-3,"pv","","financial"];SocialCalc.Formula.FunctionList.RATE=[SocialCalc.Formula.InterestFunctions,-3,"rate","","financial"];SocialCalc.Formula.NPVFunction=function(b,f,c,h){var d,g,e,i,j;var a=SocialCalc.Formula;var g=a.OperandAsNumber(h,c);if(a.CheckForErrorValue(f,g)){return}e=0;d="n";i=1;while(c.length){j=a.OperandValueAndType(h,c);if(j.type.charAt(0)=="n"){i*=(1+g.value);if(i==0){a.PushOperand(f,"e#DIV/0!",0);return}e+=j.value/i;d=a.LookupResultType(j.type,d||j.type,a.TypeLookupTable.plus)}else{if(j.type.charAt(0)=="e"&&d.charAt(0)!="e"){d=j.type;break}}}if(d.charAt(0)=="n"){d="n$"}a.PushOperand(f,d,e);return};SocialCalc.Formula.FunctionList.NPV=[SocialCalc.Formula.NPVFunction,-2,"npv","","financial"];SocialCalc.Formula.IRRFunction=function(s,r,e,d){var h,j,f,c,k,u,t,p,o,a,n,q;var l=[];var g=[];var b=SocialCalc.Formula;l.push(e.pop());while(l.length){h=b.OperandValueAndType(d,l);if(h.type.charAt(0)=="n"){g.push(h.value)}else{if(h.type.charAt(0)=="e"){b.PushOperand(r,"e#VALUE!",0);return}}}if(!g.length){b.PushOperand(r,"e#NUM!",0);return}j={value:0};if(e.length){j=b.OperandAsNumber(d,e);if(j.type.charAt(0)!="n"&&j.type.charAt(0)!="b"){b.PushOperand(r,"e#VALUE!",0);return}if(e.length){b.FunctionArgsError(s,r);return}}j.value=j.value||0.1;c=20;k=0;u=1e-7;t=j.value;a=1;while((a>=0?a:-a)>u&&(t!=p)){a=0;n=1;for(q=0;q<g.length;q++){n*=(1+t);if(n==0){b.PushOperand(r,"e#DIV/0!",0);return}a+=g[q]/n}if(f!=null){o=(a-f)/(t-p);p=t;t=t-a/o;f=a}else{p=t;t=1.1*t;f=a}k++;if(k>=c){b.PushOperand(r,"e#NUM!",0);return}}b.PushOperand(r,"n%",t);return};SocialCalc.Formula.FunctionList.IRR=[SocialCalc.Formula.IRRFunction,-1,"irr","","financial"];SocialCalc.Formula.SheetCache={sheets:{},waitingForLoading:null,constants:{asloaded:0,recalcing:1,recalcdone:2},loadsheet:null};SocialCalc.Formula.FindInSheetCache=function(b){var c;var a=SocialCalc.Formula.SheetCache;var d=SocialCalc.Formula.NormalizeSheetName(b);if(a.sheets[d]){return a.sheets[d].sheet}if(a.waitingForLoading){return null}a.waitingForLoading=d;return null};SocialCalc.Formula.AddSheetToCache=function(d,e){var f=null;var c=SocialCalc.Formula.SheetCache;var a=c.constants;var b=SocialCalc.Formula.NormalizeSheetName(d);if(e){f=new SocialCalc.Sheet();f.ParseSheetSave(e)}c.sheets[b]={sheet:f,recalcstate:a.asloaded,name:b};SocialCalc.Formula.FreshnessInfo.sheets[b]=true;return f};SocialCalc.Formula.NormalizeSheetName=function(a){if(SocialCalc.Callbacks.NormalizeSheetName){return SocialCalc.Callbacks.NormalizeSheetName(a)}else{return a.toLowerCase()}};SocialCalc.Formula.RemoteFunctionInfo={waitingForServer:null};SocialCalc.Formula.FreshnessInfo={sheets:{},volatiles:{},recalc_completed:false};SocialCalc.Formula.FreshnessInfoReset=function(){var a=SocialCalc.Formula.FreshnessInfo;a.sheets={};a.volatiles={};a.recalc_completed=false};SocialCalc.Formula.PlainCoord=function(a){if(a.indexOf("$")==-1){return a}return a.replace(/\$/g,"")};SocialCalc.Formula.OrderRangeParts=function(e,d){var c,b;var a={};c=SocialCalc.coordToCr(e);b=SocialCalc.coordToCr(d);if(c.col>b.col){a.c1=b.col;a.c2=c.col}else{a.c1=c.col;a.c2=b.col}if(c.row>b.row){a.r1=b.row;a.r2=c.row}else{a.r1=c.row;a.r2=b.row}return a};SocialCalc.Formula.TestCriteria=function(e,c,h){var g,d,f,b,a;if(h==null){return false}h=h+"";g=h.charAt(0);if(g=="="||g=="<"||g==">"){d=h.substring(1)}else{g=h.substring(0,2);if(g=="<="||g=="<>"||g==">="){d=h.substring(2)}else{g="none";d=h}}f=SocialCalc.DetermineValueType(d);if(!f.type){if(g=="none"){return false}if(c.charAt(0)=="b"){if(g=="="){return true}}else{if(g=="<>"){return true}}return false}b=false;if(f.type.charAt(0)=="n"&&c.charAt(0)=="t"){a=SocialCalc.DetermineValueType(e);if(a.type.charAt(0)=="n"){e=a.value;c=a.type}}if(c.charAt(0)=="n"&&f.type.charAt(0)=="n"){e=e-0;f.value=f.value-0;switch(g){case"<":b=e<f.value;break;case"<=":b=e<=f.value;break;case"=":case"none":b=e==f.value;break;case">=":b=e>=f.value;break;case">":b=e>f.value;break;case"<>":b=e!=f.value;break}}else{if(c.charAt(0)=="e"){b=false}else{if(f.type.charAt(0)=="e"){b=false}else{if(c.charAt(0)=="n"){e=SocialCalc.format_number_for_display(e,"n","")}if(f.type.charAt(0)=="n"){return false}e=e?e.toLowerCase():"";f.value=f.value?f.value.toLowerCase():"";switch(g){case"<":b=e<f.value;break;case"<=":b=e<=f.value;break;case"=":b=e==f.value;break;case"none":b=e.substring(0,f.value.length)==f.value;break;case">=":b=e>=f.value;break;case">":b=e>f.value;break;case"<>":b=e!=f.value;break}}}}return b};