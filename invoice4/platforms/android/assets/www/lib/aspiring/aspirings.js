var SocialCalc;if(!SocialCalc){SocialCalc={}}SocialCalc.Callbacks={expand_wiki:null,expand_markup:function(a,c,b){return SocialCalc.default_expand_markup(a,c,b)},MakePageLink:null,NormalizeSheetName:null};SocialCalc.Cell=function(a){this.coord=a;this.datavalue="";this.datatype=null;this.formula="";this.valuetype="b"};SocialCalc.CellProperties={coord:1,datavalue:1,datatype:1,formula:1,valuetype:1,errors:1,comment:1,bt:2,br:2,bb:2,bl:2,layout:2,font:2,color:2,bgcolor:2,cellformat:2,nontextvalueformat:2,textvalueformat:2,colspan:2,rowspan:2,cssc:2,csss:2,mod:2,displaystring:3,parseinfo:3,hcolspan:3,hrowspan:3};SocialCalc.CellPropertiesTable={bt:"borderstyle",br:"borderstyle",bb:"borderstyle",bl:"borderstyle",layout:"layout",font:"font",color:"color",bgcolor:"color",cellformat:"cellformat",nontextvalueformat:"valueformat",textvalueformat:"valueformat"};SocialCalc.Sheet=function(){SocialCalc.ResetSheet(this);this.statuscallback=null;this.statuscallbackparams=null};SocialCalc.ResetSheet=function(a,b){a.cells={};a.attribs={lastcol:1,lastrow:1,defaultlayout:0};a.rowattribs={hide:{},height:{}};a.colattribs={width:{},hide:{}};a.names={};a.layouts=[];a.layouthash={};a.fonts=[];a.fonthash={};a.colors=[];a.colorhash={};a.borderstyles=[];a.borderstylehash={};a.cellformats=[];a.cellformathash={};a.valueformats=[];a.valueformathash={};a.copiedfrom="";a.changes=new SocialCalc.UndoStack();a.renderneeded=false;a.changedrendervalues=true;a.recalcchangedavalue=false};SocialCalc.Sheet.prototype.ResetSheet=function(){SocialCalc.ResetSheet(this)};SocialCalc.Sheet.prototype.AddCell=function(a){return this.cells[a.coord]=a};SocialCalc.Sheet.prototype.GetAssuredCell=function(a){return this.cells[a]||this.AddCell(new SocialCalc.Cell(a))};SocialCalc.Sheet.prototype.ParseSheetSave=function(a){SocialCalc.ParseSheetSave(a,this)};SocialCalc.Sheet.prototype.CellFromStringParts=function(a,c,b){return SocialCalc.CellFromStringParts(this,a,c,b)};SocialCalc.Sheet.prototype.CreateSheetSave=function(a,b){return SocialCalc.CreateSheetSave(this,a,b)};SocialCalc.Sheet.prototype.CellToString=function(a){return SocialCalc.CellToString(this,a)};SocialCalc.Sheet.prototype.CanonicalizeSheet=function(a){return SocialCalc.CanonicalizeSheet(this,a)};SocialCalc.Sheet.prototype.EncodeCellAttributes=function(a){return SocialCalc.EncodeCellAttributes(this,a)};SocialCalc.Sheet.prototype.EncodeSheetAttributes=function(){return SocialCalc.EncodeSheetAttributes(this)};SocialCalc.Sheet.prototype.DecodeCellAttributes=function(c,b,a){return SocialCalc.DecodeCellAttributes(this,c,b,a)};SocialCalc.Sheet.prototype.DecodeSheetAttributes=function(a){return SocialCalc.DecodeSheetAttributes(this,a)};SocialCalc.Sheet.prototype.ScheduleSheetCommands=function(b,c,a){return SocialCalc.ScheduleSheetCommands(this,b,c,a)};SocialCalc.Sheet.prototype.SheetUndo=function(){return SocialCalc.SheetUndo(this)};SocialCalc.Sheet.prototype.SheetRedo=function(){return SocialCalc.SheetRedo(this)};SocialCalc.Sheet.prototype.CreateAuditString=function(){return SocialCalc.CreateAuditString(this)};SocialCalc.Sheet.prototype.GetStyleNum=function(a,b){return SocialCalc.GetStyleNum(this,a,b)};SocialCalc.Sheet.prototype.GetStyleString=function(b,a){return SocialCalc.GetStyleString(this,b,a)};SocialCalc.Sheet.prototype.RecalcSheet=function(){return SocialCalc.RecalcSheet(this)};SocialCalc.ParseSheetSave=function(d,c){var o=d.split(/\r\n|\n/);var f=[];var p;var h,g,n,m,k,l,b,a;var e=SocialCalc.Constants;for(h=0;h<o.length;h++){p=o[h];f=p.split(":");switch(f[0]){case"cell":l=c.GetAssuredCell(f[1]);g=2;c.CellFromStringParts(l,f,g);break;case"col":k=f[1];g=2;while(n=f[g++]){switch(n){case"w":c.colattribs.width[k]=f[g++];break;case"hide":c.colattribs.hide[k]=f[g++];break;default:throw e.s_pssUnknownColType+" '"+n+"'";break}}break;case"row":k=f[1]-0;g=2;while(n=f[g++]){switch(n){case"h":c.rowattribs.height[k]=f[g++]-0;break;case"hide":c.rowattribs.hide[k]=f[g++];break;default:throw e.s_pssUnknownRowType+" '"+n+"'";break}}break;case"sheet":b=c.attribs;g=1;while(n=f[g++]){switch(n){case"c":b.lastcol=f[g++]-0;break;case"r":b.lastrow=f[g++]-0;break;case"w":b.defaultcolwidth=f[g++]+"";break;case"h":b.defaultrowheight=f[g++]-0;break;case"tf":b.defaulttextformat=f[g++]-0;break;case"ntf":b.defaultnontextformat=f[g++]-0;break;case"layout":b.defaultlayout=f[g++]-0;break;case"font":b.defaultfont=f[g++]-0;break;case"tvf":b.defaulttextvalueformat=f[g++]-0;break;case"ntvf":b.defaultnontextvalueformat=f[g++]-0;break;case"color":b.defaultcolor=f[g++]-0;break;case"bgcolor":b.defaultbgcolor=f[g++]-0;break;case"circularreferencecell":b.circularreferencecell=f[g++];break;case"recalc":b.recalc=f[g++];break;case"needsrecalc":b.needsrecalc=f[g++];break;default:g+=1;break}}break;case"name":a=SocialCalc.decodeFromSave(f[1]).toUpperCase();c.names[a]={desc:SocialCalc.decodeFromSave(f[2])};c.names[a].definition=SocialCalc.decodeFromSave(f[3]);break;case"layout":f=o[h].match(/^layout\:(\d+)\:(.+)$/);c.layouts[f[1]-0]=f[2];c.layouthash[f[2]]=f[1]-0;break;case"font":c.fonts[f[1]-0]=f[2];c.fonthash[f[2]]=f[1]-0;break;case"color":c.colors[f[1]-0]=f[2];c.colorhash[f[2]]=f[1]-0;break;case"border":c.borderstyles[f[1]-0]=f[2];c.borderstylehash[f[2]]=f[1]-0;break;case"cellformat":m=SocialCalc.decodeFromSave(f[2]);c.cellformats[f[1]-0]=m;c.cellformathash[m]=f[1]-0;break;case"valueformat":m=SocialCalc.decodeFromSave(f[2]);c.valueformats[f[1]-0]=m;c.valueformathash[m]=f[1]-0;break;case"version":break;case"copiedfrom":c.copiedfrom=f[1]+":"+f[2];break;case"clipboardrange":case"clipboard":break;case"":break;default:alert(e.s_pssUnknownLineType+" '"+f[0]+"'");throw e.s_pssUnknownLineType+" '"+f[0]+"'";break}f=null}};SocialCalc.CellFromStringParts=function(e,a,f,c){var a,d,b;while(d=f[c++]){switch(d){case"v":a.datavalue=SocialCalc.decodeFromSave(f[c++])-0;a.datatype="v";a.valuetype="n";break;case"t":a.datavalue=SocialCalc.decodeFromSave(f[c++]);a.datatype="t";a.valuetype=SocialCalc.Constants.textdatadefaulttype;break;case"vt":b=f[c++];a.valuetype=b;if(b.charAt(0)=="n"){a.datatype="v";a.datavalue=SocialCalc.decodeFromSave(f[c++])-0}else{a.datatype="t";a.datavalue=SocialCalc.decodeFromSave(f[c++])}break;case"vtf":b=f[c++];a.valuetype=b;if(b.charAt(0)=="n"){a.datavalue=SocialCalc.decodeFromSave(f[c++])-0}else{a.datavalue=SocialCalc.decodeFromSave(f[c++])}a.formula=SocialCalc.decodeFromSave(f[c++]);a.datatype="f";break;case"vtc":b=f[c++];a.valuetype=b;if(b.charAt(0)=="n"){a.datavalue=SocialCalc.decodeFromSave(f[c++])-0}else{a.datavalue=SocialCalc.decodeFromSave(f[c++])}a.formula=SocialCalc.decodeFromSave(f[c++]);a.datatype="c";break;case"e":a.errors=SocialCalc.decodeFromSave(f[c++]);break;case"b":a.bt=f[c++]-0;a.br=f[c++]-0;a.bb=f[c++]-0;a.bl=f[c++]-0;break;case"l":a.layout=f[c++]-0;break;case"f":a.font=f[c++]-0;break;case"c":a.color=f[c++]-0;break;case"bg":a.bgcolor=f[c++]-0;break;case"cf":a.cellformat=f[c++]-0;break;case"ntvf":a.nontextvalueformat=f[c++]-0;break;case"tvf":a.textvalueformat=f[c++]-0;break;case"colspan":a.colspan=f[c++]-0;break;case"rowspan":a.rowspan=f[c++]-0;break;case"cssc":a.cssc=f[c++];break;case"csss":a.csss=SocialCalc.decodeFromSave(f[c++]);break;case"mod":c+=1;break;case"comment":a.comment=SocialCalc.decodeFromSave(f[c++]);break;default:throw SocialCalc.Constants.s_cfspUnknownCellType+" '"+d+"'";break}}};SocialCalc.sheetfields=["defaultrowheight","defaultcolwidth","circularreferencecell","recalc","needsrecalc"];SocialCalc.sheetfieldsshort=["h","w","circularreferencecell","recalc","needsrecalc"];SocialCalc.sheetfieldsxlat=["defaulttextformat","defaultnontextformat","defaulttextvalueformat","defaultnontextvalueformat","defaultcolor","defaultbgcolor","defaultfont","defaultlayout"];SocialCalc.sheetfieldsxlatshort=["tf","ntf","tvf","ntvf","color","bgcolor","font","layout"];SocialCalc.sheetfieldsxlatxlt=["cellformat","cellformat","valueformat","valueformat","color","color","font","layout"];SocialCalc.CreateSheetSave=function(w,q,f){var c,p,n,g,d,y,j,m,v,a,z,o,s,A,x,B,h;var k=[];var e;w.CanonicalizeSheet(f||SocialCalc.Constants.doCanonicalizeSheet);var u=w.xlt;if(q){e=SocialCalc.ParseRange(q)}else{e={cr1:{row:1,col:1},cr2:{row:u.maxrow,col:u.maxcol}}}p=e.cr1;n=e.cr2;k.push("version:1.5");for(g=p.row;g<=n.row;g++){for(d=p.col;d<=n.col;d++){y=SocialCalc.crToCoord(d,g);c=w.cells[y];if(!c){continue}m=w.CellToString(c);if(m.length==0){continue}m="cell:"+y+m;k.push(m)}}for(d=1;d<=u.maxcol;d++){y=SocialCalc.rcColname(d);if(w.colattribs.width[y]){k.push("col:"+y+":w:"+w.colattribs.width[y])}if(w.colattribs.hide[y]){k.push("col:"+y+":hide:"+w.colattribs.hide[y])}}for(g=1;g<=u.maxrow;g++){if(w.rowattribs.height[g]){k.push("row:"+g+":h:"+w.rowattribs.height[g])}if(w.rowattribs.hide[g]){k.push("row:"+g+":hide:"+w.rowattribs.hide[g])}}m="sheet:c:"+u.maxcol+":r:"+u.maxrow;for(z=0;z<SocialCalc.sheetfields.length;z++){v=SocialCalc.encodeForSave(w.attribs[SocialCalc.sheetfields[z]]);if(v){m+=":"+SocialCalc.sheetfieldsshort[z]+":"+v}}for(z=0;z<SocialCalc.sheetfieldsxlat.length;z++){v=w.attribs[SocialCalc.sheetfieldsxlat[z]];if(v){m+=":"+SocialCalc.sheetfieldsxlatshort[z]+":"+u[SocialCalc.sheetfieldsxlatxlt[z]+"sxlat"][v]}}k.push(m);for(z=1;z<u.newborderstyles.length;z++){k.push("border:"+z+":"+u.newborderstyles[z])}for(z=1;z<u.newcellformats.length;z++){k.push("cellformat:"+z+":"+SocialCalc.encodeForSave(u.newcellformats[z]))}for(z=1;z<u.newcolors.length;z++){k.push("color:"+z+":"+u.newcolors[z])}for(z=1;z<u.newfonts.length;z++){k.push("font:"+z+":"+u.newfonts[z])}for(z=1;z<u.newlayouts.length;z++){k.push("layout:"+z+":"+u.newlayouts[z])}for(z=1;z<u.newvalueformats.length;z++){k.push("valueformat:"+z+":"+SocialCalc.encodeForSave(u.newvalueformats[z]))}for(z=0;z<u.namesorder.length;z++){B=u.namesorder[z];k.push("name:"+SocialCalc.encodeForSave(B).toUpperCase()+":"+SocialCalc.encodeForSave(w.names[B].desc)+":"+SocialCalc.encodeForSave(w.names[B].definition))}if(q){k.push("copiedfrom:"+SocialCalc.crToCoord(p.col,p.row)+":"+SocialCalc.crToCoord(n.col,n.row))}k.push("");delete w.xlt;return k.join("\n")};SocialCalc.CellToString=function(f,j){var j,m,h,e,k,a,g,c,d;m="";if(!j){return m}h=SocialCalc.encodeForSave(j.datavalue);if(j.datatype=="v"){if(j.valuetype=="n"){m+=":v:"+h}else{m+=":vt:"+j.valuetype+":"+h}}else{if(j.datatype=="t"){if(j.valuetype==SocialCalc.Constants.textdatadefaulttype){m+=":t:"+h}else{m+=":vt:"+j.valuetype+":"+h}}else{e=SocialCalc.encodeForSave(j.formula);if(j.datatype=="f"){m+=":vtf:"+j.valuetype+":"+h+":"+e}else{if(j.datatype=="c"){m+=":vtc:"+j.valuetype+":"+h+":"+e}}}}if(j.errors){m+=":e:"+SocialCalc.encodeForSave(j.errors)}k=j.bt||"";a=j.br||"";g=j.bb||"";c=j.bl||"";if(f.xlt){d=f.xlt;if(k||a||g||c){m+=":b:"+d.borderstylesxlat[k||0]+":"+d.borderstylesxlat[a||0]+":"+d.borderstylesxlat[g||0]+":"+d.borderstylesxlat[c||0]}if(j.layout){m+=":l:"+d.layoutsxlat[j.layout]}if(j.font){m+=":f:"+d.fontsxlat[j.font]}if(j.color){m+=":c:"+d.colorsxlat[j.color]}if(j.bgcolor){m+=":bg:"+d.colorsxlat[j.bgcolor]}if(j.cellformat){m+=":cf:"+d.cellformatsxlat[j.cellformat]}if(j.textvalueformat){m+=":tvf:"+d.valueformatsxlat[j.textvalueformat]}if(j.nontextvalueformat){m+=":ntvf:"+d.valueformatsxlat[j.nontextvalueformat]}}else{if(k||a||g||c){m+=":b:"+k+":"+a+":"+g+":"+c}if(j.layout){m+=":l:"+j.layout}if(j.font){m+=":f:"+j.font}if(j.color){m+=":c:"+j.color}if(j.bgcolor){m+=":bg:"+j.bgcolor}if(j.cellformat){m+=":cf:"+j.cellformat}if(j.textvalueformat){m+=":tvf:"+j.textvalueformat}if(j.nontextvalueformat){m+=":ntvf:"+j.nontextvalueformat}}if(j.colspan){m+=":colspan:"+j.colspan}if(j.rowspan){m+=":rowspan:"+j.rowspan}if(j.cssc){m+=":cssc:"+j.cssc}if(j.csss){m+=":csss:"+SocialCalc.encodeForSave(j.csss)}if(j.mod){m+=":mod:"+j.mod}if(j.comment){m+=":comment:"+SocialCalc.encodeForSave(j.comment)}return m};SocialCalc.CanonicalizeSheet=function(r,k){var w,u,e,b,g,q,B,t,j,f,A,y,n;var m=0;var h=0;var s=["borderstyle","cellformat","color","font","layout","valueformat"];var p={};p.namesorder=[];for(B in r.names){p.namesorder.push(B)}p.namesorder.sort();if(!SocialCalc.Constants.doCanonicalizeSheet||!k){for(q=0;q<s.length;q++){B=s[q];p["new"+B+"s"]=r[B+"s"];w=r[B+"s"].length;j=new Array(w);j[0]="";for(y=1;y<w;y++){j[y]=y}p[B+"sxlat"]=j}p.maxrow=r.attribs.lastrow;p.maxcol=r.attribs.lastcol;r.xlt=p;return}for(q=0;q<s.length;q++){B=s[q];p[B+"sUsed"]={}}var c=p.colorsUsed;var d=p.borderstylesUsed;var o=p.fontsUsed;var x=p.layoutsUsed;var C=p.cellformatsUsed;var z=p.valueformatsUsed;for(u in r.cells){e=SocialCalc.coordToCr(u);b=r.cells[u];g=false;if(b.valuetype&&b.valuetype!="b"){g=true}if(b.color){c[b.color]=1;g=true}if(b.bgcolor){c[b.bgcolor]=1;g=true}if(b.bt){d[b.bt]=1;g=true}if(b.br){d[b.br]=1;g=true}if(b.bb){d[b.bb]=1;g=true}if(b.bl){d[b.bl]=1;g=true}if(b.layout){x[b.layout]=1;g=true}if(b.font){o[b.font]=1;g=true}if(b.cellformat){C[b.cellformat]=1;g=true}if(b.textvalueformat){z[b.textvalueformat]=1;g=true}if(b.nontextvalueformat){z[b.nontextvalueformat]=1;g=true}if(g){if(e.row>m){m=e.row}if(e.col>h){h=e.col}}}for(y=0;y<SocialCalc.sheetfieldsxlat.length;y++){n=r.attribs[SocialCalc.sheetfieldsxlat[y]];if(n){p[SocialCalc.sheetfieldsxlatxlt[y]+"sUsed"][n]=1}}B={height:1,hide:1};for(n in B){for(e in r.rowattribs[n]){if(e>m){m=e}}}B={hide:1,width:1};for(n in B){for(u in r.colattribs[n]){e=SocialCalc.coordToCr(u+"1");if(e.col>h){h=e.col}}}for(q=0;q<s.length;q++){B=s[q];t=[];f=p[B+"sUsed"];for(n in f){t.push(r[B+"s"][n])}t.sort();t.unshift("");j=[""];A=r[B+"hash"];for(y=1;y<t.length;y++){j[A[t[y]]]=y}p[B+"sxlat"]=j;p["new"+B+"s"]=t}p.maxrow=m||1;p.maxcol=h||1;r.xlt=p};SocialCalc.EncodeCellAttributes=function(k,h){var m,f,l,j,e;var o={};var c=function(b){o[b]={def:true,val:""}};var g=function(b){for(var p=0;p<b.length;p++){c(b[p])}};var a=function(p,b){o[p].def=false;o[p].val=b||""};var d=function(p,b){if(b=="*"){return}o[p].def=false;o[p].val=b};var n=k.GetAssuredCell(h);c("alignhoriz");if(n.cellformat){a("alignhoriz",k.cellformats[n.cellformat])}g(["alignvert","padtop","padright","padbottom","padleft"]);if(n.layout){e=k.layouts[n.layout].match(/^padding:\s*(\S+)\s+(\S+)\s+(\S+)\s+(\S+);vertical-align:\s*(\S+);/);d("padtop",e[1]);d("padright",e[2]);d("padbottom",e[3]);d("padleft",e[4]);d("alignvert",e[5])}g(["fontfamily","fontlook","fontsize"]);if(n.font){e=k.fonts[n.font].match(/^(\*|\S+? \S+?) (\S+?) (\S.*)$/);d("fontfamily",e[3]);d("fontsize",e[2]);d("fontlook",e[1])}c("textcolor");if(n.color){a("textcolor",k.colors[n.color])}c("bgcolor");if(n.bgcolor){a("bgcolor",k.colors[n.bgcolor])}g(["numberformat","textformat"]);if(n.nontextvalueformat){a("numberformat",k.valueformats[n.nontextvalueformat])}if(n.textvalueformat){a("textformat",k.valueformats[n.textvalueformat])}g(["colspan","rowspan"]);a("colspan",n.colspan||1);a("rowspan",n.rowspan||1);for(f=0;f<4;f++){l="trbl".charAt(f);j="b"+l;c(j);a(j,n[j]?k.borderstyles[n[j]]:"");c(j+"thickness");c(j+"style");c(j+"color");if(n[j]){e=k.borderstyles[n[j]].match(/(\S+)\s+(\S+)\s+(\S.+)/);a(j+"thickness",e[1]);a(j+"style",e[2]);a(j+"color",e[3])}}g(["cssc","csss","mod"]);a("cssc",n.cssc||"");a("csss",n.csss||"");a("mod",n.mod||"n");return o};SocialCalc.EncodeSheetAttributes=function(d){var g;var h=d.attribs;var b={};var c=function(j){b[j]={def:true,val:""}};var e=function(j){for(var k=0;k<j.length;k++){c(j[k])}};var f=function(k,j){b[k].def=false;b[k].val=j||g};var a=function(k,j){if(j=="*"){return}b[k].def=false;b[k].val=j};c("colwidth");if(h.defaultcolwidth){f("colwidth",h.defaultcolwidth)}c("rowheight");if(h.rowheight){f("rowheight",h.defaultrowheight)}c("textalignhoriz");if(h.defaulttextformat){f("textalignhoriz",d.cellformats[h.defaulttextformat])}c("numberalignhoriz");if(h.defaultnontextformat){f("numberalignhoriz",d.cellformats[h.defaultnontextformat])}e(["alignvert","padtop","padright","padbottom","padleft"]);if(h.defaultlayout){parts=d.layouts[h.defaultlayout].match(/^padding:\s*(\S+)\s+(\S+)\s+(\S+)\s+(\S+);vertical-align:\s*(\S+);/);a("padtop",parts[1]);a("padright",parts[2]);a("padbottom",parts[3]);a("padleft",parts[4]);a("alignvert",parts[5])}e(["fontfamily","fontlook","fontsize"]);if(h.defaultfont){parts=d.fonts[h.defaultfont].match(/^(\*|\S+? \S+?) (\S+?) (\S.*)$/);a("fontfamily",parts[3]);a("fontsize",parts[2]);a("fontlook",parts[1])}c("textcolor");if(h.defaultcolor){f("textcolor",d.colors[h.defaultcolor])}c("bgcolor");if(h.defaultbgcolor){f("bgcolor",d.colors[h.defaultbgcolor])}e(["numberformat","textformat"]);if(h.defaultnontextvalueformat){f("numberformat",d.valueformats[h.defaultnontextvalueformat])}if(h.defaulttextvalueformat){f("textformat",d.valueformats[h.defaulttextvalueformat])}c("recalc");if(h.recalc){f("recalc",h.recalc)}return b};SocialCalc.DecodeCellAttributes=function(k,g,l,e){var n,m,j;var o=k.GetAssuredCell(g);var d=false;var h=function(q,p,b){var r;if(l[q]){if(l[q].def){r=""}else{r=l[q].val}if(r!=(p||"")){c(b+" "+r)}}};var f="";var c=function(b){if(f){f+="\n"}f+="set "+(e||g)+" "+b;d=true};h("alignhoriz",k.cellformats[o.cellformat],"cellformat");if(!l.alignvert.def||!l.padtop.def||!l.padright.def||!l.padbottom.def||!l.padleft.def){n="padding:"+(l.padtop.def?"* ":l.padtop.val+" ")+(l.padright.def?"* ":l.padright.val+" ")+(l.padbottom.def?"* ":l.padbottom.val+" ")+(l.padleft.def?"*":l.padleft.val)+";vertical-align:"+(l.alignvert.def?"*;":l.alignvert.val+";")}else{n=""}if(n!=(k.layouts[o.layout]||"")){c("layout "+n)}if(!l.fontlook.def||!l.fontsize.def||!l.fontfamily.def){n=(l.fontlook.def?"* ":l.fontlook.val+" ")+(l.fontsize.def?"* ":l.fontsize.val+" ")+(l.fontfamily.def?"*":l.fontfamily.val)}else{n=""}if(n!=(k.fonts[o.font]||"")){c("font "+n)}h("textcolor",k.colors[o.color],"color");h("bgcolor",k.colors[o.bgcolor],"bgcolor");h("numberformat",k.valueformats[o.nontextvalueformat],"nontextvalueformat");h("textformat",k.valueformats[o.textvalueformat],"textvalueformat");for(var a=0;a<4;a++){m="trbl".charAt(a);j="b"+m;h(j,k.borderstyles[o[j]],j)}h("cssc",o.cssc,"cssc");h("csss",o.csss,"csss");if(l.mod){if(l.mod.def){n="n"}else{n=l.mod.val}if(n!=(o.mod||"n")){if(n=="n"){n=""}c("mod "+n)}}if(d){return f}else{return null}};SocialCalc.DecodeSheetAttributes=function(c,f){var e;var h=c.attribs;var g=false;var d=function(l,k,j){var m;if(f[l]){if(f[l].def){m=""}else{m=f[l].val}if(m!=(k||"")){a(j+" "+m)}}};var b="";var a=function(j){if(b){b+="\n"}b+="set sheet "+j;g=true};d("colwidth",h.defaultcolwidth,"defaultcolwidth");d("rowheight",h.defaultrowheight,"defaultrowheight");d("textalignhoriz",c.cellformats[h.defaulttextformat],"defaulttextformat");d("numberalignhoriz",c.cellformats[h.defaultnontextformat],"defaultnontextformat");if(!f.alignvert.def||!f.padtop.def||!f.padright.def||!f.padbottom.def||!f.padleft.def){e="padding:"+(f.padtop.def?"* ":f.padtop.val+" ")+(f.padright.def?"* ":f.padright.val+" ")+(f.padbottom.def?"* ":f.padbottom.val+" ")+(f.padleft.def?"*":f.padleft.val)+";vertical-align:"+(f.alignvert.def?"*;":f.alignvert.val+";")}else{e=""}if(e!=(c.layouts[h.defaultlayout]||"")){a("defaultlayout "+e)}if(!f.fontlook.def||!f.fontsize.def||!f.fontfamily.def){e=(f.fontlook.def?"* ":f.fontlook.val+" ")+(f.fontsize.def?"* ":f.fontsize.val+" ")+(f.fontfamily.def?"*":f.fontfamily.val)}else{e=""}if(e!=(c.fonts[h.defaultfont]||"")){a("defaultfont "+e)}d("textcolor",c.colors[h.defaultcolor],"defaultcolor");d("bgcolor",c.colors[h.defaultbgcolor],"defaultbgcolor");d("numberformat",c.valueformats[h.defaultnontextvalueformat],"defaultnontextvalueformat");d("textformat",c.valueformats[h.defaulttextvalueformat],"defaulttextvalueformat");d("recalc",c.attribs.recalc,"recalc");if(g){return b}else{return null}};SocialCalc.SheetCommandInfo={sheetobj:null,parseobj:null,timerobj:null,firsttimerdelay:50,timerdelay:1,maxtimeslice:100,saveundo:false,CmdExtensionCallbacks:{},cmdextensionbusy:""};SocialCalc.ScheduleSheetCommands=function(c,a,e,b){if(SocialCalc.Callbacks.broadcast&&!b){if(a!="redisplay"&&a!="set sheet defaulttextvalueformat text-wiki"&&a!="recalc"){SocialCalc.Callbacks.broadcast("execute",{cmdtype:"scmd",id:c.sheetid,cmdstr:a,saveundo:e})}}var d=SocialCalc.SheetCommandInfo;d.sheetobj=c;d.parseobj=new SocialCalc.Parse(a);d.saveundo=e;if(d.sheetobj.statuscallback){c.statuscallback(d,"cmdstart","",d.sheetobj.statuscallbackparams)}if(d.saveundo){d.sheetobj.changes.PushChange("")}d.timerobj=window.setTimeout(SocialCalc.SheetCommandsTimerRoutine,d.firsttimerdelay)};SocialCalc.SheetCommandsTimerRoutine=function(){var a;var b=SocialCalc.SheetCommandInfo;var c=new Date();b.timerobj=null;while(!b.parseobj.EOF()){a=SocialCalc.ExecuteSheetCommand(b.sheetobj,b.parseobj,b.saveundo);if(a){alert(a)}b.parseobj.NextLine();if(b.cmdextensionbusy.length>0){if(b.sheetobj.statuscallback){b.sheetobj.statuscallback(b,"cmdextension",b.cmdextensionbusy,b.sheetobj.statuscallbackparams)}return}if(((new Date())-c)>=b.maxtimeslice){b.timerobj=window.setTimeout(SocialCalc.SheetCommandsTimerRoutine,b.timerdelay);return}}if(b.sheetobj.statuscallback){b.sheetobj.statuscallback(b,"cmdend","",b.sheetobj.statuscallbackparams)}};SocialCalc.ResumeFromCmdExtension=function(){var a=SocialCalc.SheetCommandInfo;a.cmdextensionbusy="";SocialCalc.SheetCommandsTimerRoutine()};SocialCalc.ExecuteSheetCommand=function(ar,ae,N){var L,af,R,O,l,az,ap,Q,ah,aq,aA;var k,j,y,ai,A,z,c;var av,f,M,u,q,h,ab;var F,ao,aB,Z,B;var ak,I,a,aj,x,an,n,au,G,w;var b,U,H,D,al,e;var ay,s,V,K,d,ax,S,p;var E,ad,r,o,ac;var aa,X,T;var C;var g=ar.attribs;var at=ar.changes;var v=SocialCalc.CellProperties;var am=SocialCalc.Constants;var Y=function(){var aC=SocialCalc.ParseRange(O);k=aC.cr1;j=aC.cr2;if(j.col>g.lastcol){g.lastcol=j.col}if(j.row>g.lastrow){g.lastrow=j.row}};ah="";L=ae.RestOfStringNoMove();if(N){ar.changes.AddDo(L)}af=ae.NextToken();switch(af){case"set":O=ae.NextToken();l=ae.NextToken();R=ae.RestOfString();aq="set "+O+" "+l;if(O=="sheet"){ar.renderneeded=true;switch(l){case"defaultcolwidth":if(N){at.AddUndo(aq,g[l])}g[l]=R;break;case"defaultcolor":case"defaultbgcolor":if(N){at.AddUndo(aq,ar.GetStyleString("color",g[l]))}g[l]=ar.GetStyleNum("color",R);break;case"defaultlayout":if(N){at.AddUndo(aq,ar.GetStyleString("layout",g[l]))}g[l]=ar.GetStyleNum("layout",R);break;case"defaultfont":if(N){at.AddUndo(aq,ar.GetStyleString("font",g[l]))}if(R=="* * *"){R=""}g[l]=ar.GetStyleNum("font",R);break;case"defaulttextformat":case"defaultnontextformat":if(N){at.AddUndo(aq,ar.GetStyleString("cellformat",g[l]))}g[l]=ar.GetStyleNum("cellformat",R);break;case"defaulttextvalueformat":case"defaultnontextvalueformat":if(N){at.AddUndo(aq,ar.GetStyleString("valueformat",g[l]))}g[l]=ar.GetStyleNum("valueformat",R);for(A in ar.cells){delete ar.cells[A].displaystring}break;case"lastcol":case"lastrow":if(N){at.AddUndo(aq,g[l]-0)}az=R-0;if(typeof az=="number"){g[l]=az>0?az:1}break;case"recalc":if(N){at.AddUndo(aq,g[l])}if(R=="off"){g.recalc=R}else{delete g.recalc}break;default:ah=am.s_escUnknownSheetCmd+L;break}}else{if(/(^[A-Z])([A-Z])?(:[A-Z][A-Z]?){0,1}$/i.test(O)){ar.renderneeded=true;O=O.toUpperCase();ap=O.indexOf(":");if(ap>=0){k=SocialCalc.coordToCr(O.substring(0,ap)+"1");j=SocialCalc.coordToCr(O.substring(ap+1)+"1")}else{k=SocialCalc.coordToCr(O+"1");j=k}for(y=k.col;y<=j.col;y++){if(l=="width"){A=SocialCalc.rcColname(y);if(N){at.AddUndo("set "+A+" width",ar.colattribs.width[A])}if(R.length>0){ar.colattribs.width[A]=R}else{delete ar.colattribs.width[A]}}}}else{if(/([a-z]){0,1}(\d+)/i.test(O)){Y();if(k.row!=j.row||k.col!=j.col||ar.celldisplayneeded||ar.renderneeded){ar.renderneeded=true;ar.celldisplayneeded=""}else{ar.celldisplayneeded=SocialCalc.crToCoord(k.col,k.row)}for(ai=k.row;ai<=j.row;ai++){for(y=k.col;y<=j.col;y++){A=SocialCalc.crToCoord(y,ai);z=ar.GetAssuredCell(A);if(N){at.AddUndo("set "+A+" all",ar.CellToString(z))}if(l=="value"){ap=R.indexOf(" ");z.datavalue=R.substring(ap+1)-0;delete z.errors;z.datatype="v";z.valuetype=R.substring(0,ap);delete z.displaystring;delete z.parseinfo;g.needsrecalc="yes"}else{if(l=="text"){ap=R.indexOf(" ");z.datavalue=SocialCalc.decodeFromSave(R.substring(ap+1));delete z.errors;z.datatype="t";z.valuetype=R.substring(0,ap);delete z.displaystring;delete z.parseinfo;g.needsrecalc="yes"}else{if(l=="formula"){z.datavalue=0;delete z.errors;z.datatype="f";z.valuetype="e#N/A";z.formula=R;delete z.displaystring;delete z.parseinfo;g.needsrecalc="yes"}else{if(l=="constant"){ap=R.indexOf(" ");Q=R.substring(ap+1).indexOf(" ");z.datavalue=R.substring(ap+1,ap+1+Q)-0;z.valuetype=R.substring(0,ap);if(z.valuetype.charAt(0)=="e"){z.errors=z.valuetype.substring(1)}else{delete z.errors}z.datatype="c";z.formula=R.substring(ap+Q+2);delete z.displaystring;delete z.parseinfo;g.needsrecalc="yes"}else{if(l=="empty"){z.datavalue="";delete z.errors;z.datatype=null;z.formula="";z.valuetype="b";delete z.displaystring;delete z.parseinfo;g.needsrecalc="yes"}else{if(l=="all"){if(R.length>0){z=new SocialCalc.Cell(A);ar.CellFromStringParts(z,R.split(":"),1);ar.cells[A]=z}else{delete ar.cells[A]}g.needsrecalc="yes"}else{if(/^b[trbl]$/.test(l)){z[l]=ar.GetStyleNum("borderstyle",R);ar.renderneeded=true}else{if(l=="color"||l=="bgcolor"){z[l]=ar.GetStyleNum("color",R)}else{if(l=="layout"||l=="cellformat"){z[l]=ar.GetStyleNum(l,R)}else{if(l=="font"){if(R=="* * *"){R=""}z[l]=ar.GetStyleNum("font",R)}else{if(l=="textvalueformat"||l=="nontextvalueformat"){z[l]=ar.GetStyleNum("valueformat",R);delete z.displaystring}else{if(l=="cssc"){R=R.replace(/[^a-zA-Z0-9\-]/g,"");z.cssc=R}else{if(l=="csss"){R=R.replace(/\n/g,"");z.csss=R}else{if(l=="mod"){R=R.replace(/[^yY]/g,"").toLowerCase();z.mod=R}else{if(l=="comment"){z.comment=SocialCalc.decodeFromSave(R)}else{ah=am.s_escUnknownSetCoordCmd+L}}}}}}}}}}}}}}}}}}}}break;case"merge":ar.renderneeded=true;O=ae.NextToken();R=ae.RestOfString();Y();z=ar.GetAssuredCell(k.coord);if(N){at.AddUndo("unmerge "+k.coord)}if(j.col>k.col){z.colspan=j.col-k.col+1}else{delete z.colspan}if(j.row>k.row){z.rowspan=j.row-k.row+1}else{delete z.rowspan}ar.changedrendervalues=true;break;case"unmerge":ar.renderneeded=true;O=ae.NextToken();R=ae.RestOfString();Y();z=ar.GetAssuredCell(k.coord);if(N){at.AddUndo("merge "+k.coord+":"+SocialCalc.crToCoord(k.col+(z.colspan||1)-1,k.row+(z.rowspan||1)-1))}delete z.colspan;delete z.rowspan;ar.changedrendervalues=true;break;case"erase":case"cut":ar.renderneeded=true;ar.changedrendervalues=true;O=ae.NextToken();R=ae.RestOfString();Y();if(N){at.AddUndo("changedrendervalues")}if(af=="cut"){if(N){at.AddUndo("loadclipboard",SocialCalc.encodeForSave(SocialCalc.Clipboard.clipboard))}SocialCalc.Clipboard.clipboard=SocialCalc.CreateSheetSave(ar,O)}for(ai=k.row;ai<=j.row;ai++){for(y=k.col;y<=j.col;y++){A=SocialCalc.crToCoord(y,ai);z=ar.GetAssuredCell(A);if(N){at.AddUndo("set "+A+" all",ar.CellToString(z))}if(R=="all"){delete ar.cells[A]}else{if(R=="formulas"){z.datavalue="";z.datatype=null;z.formula="";z.valuetype="b";delete z.errors;delete z.displaystring;delete z.parseinfo;if(z.comment){delete z.comment}}else{if(R=="formats"){c=new SocialCalc.Cell(A);c.datavalue=z.datavalue;c.datatype=z.datatype;c.formula=z.formula;c.valuetype=z.valuetype;if(z.comment){c.comment=z.comment}ar.cells[A]=c}}}}}g.needsrecalc="yes";break;case"fillright":case"filldown":ar.renderneeded=true;ar.changedrendervalues=true;if(N){at.AddUndo("changedrendervalues")}O=ae.NextToken();R=ae.RestOfString();Y();if(af=="fillright"){av=true;f=k.row;M=k.col+1}else{av=false;f=k.row+1;M=k.col}for(ai=f;ai<=j.row;ai++){for(y=M;y<=j.col;y++){A=SocialCalc.crToCoord(y,ai);z=ar.GetAssuredCell(A);if(N){at.AddUndo("set "+A+" all",ar.CellToString(z))}if(av){u=SocialCalc.crToCoord(k.col,ai);h=y-M+1;q=0}else{u=SocialCalc.crToCoord(y,k.row);h=0;q=ai-f+1}ab=ar.GetAssuredCell(u);if(R=="all"||R=="formats"){for(l in v){if(v[l]==1){continue}if(typeof ab[l]===undefined||v[l]==3){delete z[l]}else{z[l]=ab[l]}}}if(R=="all"||R=="formulas"){z.datavalue=ab.datavalue;z.datatype=ab.datatype;z.valuetype=ab.valuetype;if(z.datatype=="f"){z.formula=SocialCalc.OffsetFormulaCoords(ab.formula,h,q)}else{z.formula=ab.formula}delete z.parseinfo;z.errors=ab.errors}delete z.displaystring}}g.needsrecalc="yes";break;case"copy":O=ae.NextToken();R=ae.RestOfString();if(N){at.AddUndo("loadclipboard",SocialCalc.encodeForSave(SocialCalc.Clipboard.clipboard))}SocialCalc.Clipboard.clipboard=SocialCalc.CreateSheetSave(ar,O);break;case"loadclipboard":R=ae.RestOfString();if(N){at.AddUndo("loadclipboard",SocialCalc.encodeForSave(SocialCalc.Clipboard.clipboard))}SocialCalc.Clipboard.clipboard=SocialCalc.decodeFromSave(R);break;case"clearclipboard":if(N){at.AddUndo("loadclipboard",SocialCalc.encodeForSave(SocialCalc.Clipboard.clipboard))}SocialCalc.Clipboard.clipboard="";break;case"paste":ar.renderneeded=true;ar.changedrendervalues=true;if(N){at.AddUndo("changedrendervalues")}O=ae.NextToken();R=ae.RestOfString();Y();if(!SocialCalc.Clipboard.clipboard){break}F=new SocialCalc.Sheet();F.ParseSheetSave(SocialCalc.Clipboard.clipboard);ao=SocialCalc.ParseRange(F.copiedfrom);h=k.col-ao.cr1.col;q=k.row-ao.cr1.row;aB=ao.cr2.col-ao.cr1.col+1;Z=ao.cr2.row-ao.cr1.row+1;if(k.col+aB-1>g.lastcol){g.lastcol=k.col+aB-1}if(k.row+Z-1>g.lastrow){g.lastrow=k.row+Z-1}for(ai=k.row;ai<k.row+Z;ai++){for(y=k.col;y<k.col+aB;y++){A=SocialCalc.crToCoord(y,ai);z=ar.GetAssuredCell(A);if(N){at.AddUndo("set "+A+" all",ar.CellToString(z))}u=SocialCalc.crToCoord(y-h,ai-q);ab=F.GetAssuredCell(u);if(R=="all"||R=="formats"){for(l in v){if(v[l]==1){continue}if(typeof ab[l]===undefined||v[l]==3){delete z[l]}else{B=SocialCalc.CellPropertiesTable[l];if(B&&ab[l]){z[l]=ar.GetStyleNum(B,F.GetStyleString(B,ab[l]))}else{z[l]=ab[l]}}}}if(R=="all"||R=="formulas"){z.datavalue=ab.datavalue;z.datatype=ab.datatype;z.valuetype=ab.valuetype;if(z.datatype=="f"){z.formula=SocialCalc.OffsetFormulaCoords(ab.formula,h,q)}else{z.formula=ab.formula}delete z.parseinfo;z.errors=ab.errors;if(ab.comment){z.comment=ab.comment}else{if(z.comment){delete z.comment}}}delete z.displaystring}}g.needsrecalc="yes";break;case"sort":ar.renderneeded=true;ar.changedrendervalues=true;if(N){at.AddUndo("changedrendervalues")}O=ae.NextToken();Y();ay=[];s=[];V=0;for(K=0;K<=3;K++){ay[K]=ae.NextToken();s[K]=ae.NextToken();if(ay[K]){V=K}}ax={};d=[];S=[];p=[];for(ai=k.row;ai<=j.row;ai++){for(y=k.col;y<=j.col;y++){A=SocialCalc.crToCoord(y,ai);z=ar.cells[A];if(z){ax[A]=ar.CellToString(z);if(N){at.AddUndo("set "+A+" all",ax[A])}}else{if(N){at.AddUndo("set "+A+" all")}}}d.push(d.length);S.push([]);p.push([]);slast=p.length-1;for(K=0;K<=V;K++){A=ay[K]+ai;z=ar.GetAssuredCell(A);aA=z.datavalue;r=z.valuetype.charAt(0)||"b";if(r=="t"){aA=aA.toLowerCase()}S[slast].push(aA);p[slast].push(r)}}E=function(aE,aC){var aH,aD,aG,aF,aI;for(aH=0;aH<=V;aH++){if(s[aH]=="up"){aD=aE;aG=aC}else{aD=aC;aG=aE}aF=p[aD][aH];tb=p[aG][aH];if(aF=="t"){if(tb=="t"){aD=S[aD][aH];aG=S[aG][aH];aI=aD>aG?1:(aD<aG?-1:0)}else{if(tb=="n"){aI=1}else{if(tb=="b"){aI=s[aH]=="up"?-1:1}else{if(tb=="e"){aI=-1}}}}}else{if(aF=="n"){if(tb=="t"){aI=-1}else{if(tb=="n"){aD=S[aD][aH]-0;aG=S[aG][aH]-0;aI=aD>aG?1:(aD<aG?-1:0)}else{if(tb=="b"){aI=s[aH]=="up"?-1:1}else{if(tb=="e"){aI=-1}}}}}else{if(aF=="e"){if(tb=="e"){aD=S[aD][aH];aG=S[aG][aH];aI=aD>aG?1:(aD<aG?-1:0)}else{if(tb=="b"){aI=s[aH]=="up"?-1:1}else{aI=1}}}else{if(aF=="b"){if(tb=="b"){aI=0}else{aI=s[aH]=="up"?1:-1}}}}}if(aI){return aI}}aI=aE>aC?1:(aE<aC?-1:0);return aI};d.sort(E);for(ai=k.row;ai<=j.row;ai++){o=d[ai-k.row];for(y=k.col;y<=j.col;y++){A=SocialCalc.crToCoord(y,ai);ac=SocialCalc.crToCoord(y,o+k.row);if(ax[ac]){z=new SocialCalc.Cell(A);ar.CellFromStringParts(z,ax[ac].split(":"),1);if(z.datatype=="f"){z.formula=SocialCalc.OffsetFormulaCoords(z.formula,0,(ai-k.row)-o)}ar.cells[A]=z}else{delete ar.cells[A]}}}g.needsrecalc="yes";break;case"insertcol":case"insertrow":ar.renderneeded=true;ar.changedrendervalues=true;O=ae.NextToken();R=ae.RestOfString();Y();if(af=="insertcol"){h=1;ak=k.col;q=0;I=1;a=k.col;x=k.col;aj=1;an=g.lastrow;if(N){at.AddUndo("deletecol "+k.coord)}}else{h=0;ak=1;q=1;I=k.row;a=1;x=g.lastcol;aj=k.row;an=k.row;if(N){at.AddUndo("deleterow "+k.coord)}}for(ai=g.lastrow;ai>=I;ai--){for(y=g.lastcol;y>=ak;y--){u=SocialCalc.crToCoord(y,ai);A=SocialCalc.crToCoord(y+h,ai+q);if(!ar.cells[u]){delete ar.cells[A]}else{ar.cells[A]=ar.cells[u]}}}for(ai=aj;ai<=an;ai++){for(y=a;y<=x;y++){A=SocialCalc.crToCoord(y,ai);z=new SocialCalc.Cell(A);ar.cells[A]=z;u=SocialCalc.crToCoord(y-h,ai-q);ab=ar.GetAssuredCell(u);for(l in v){if(v[l]==2){z[l]=ab[l]}}}}for(A in ar.cells){z=ar.cells[A];if(z&&z.datatype=="f"){z.formula=SocialCalc.AdjustFormulaCoords(z.formula,k.col,h,k.row,q)}if(z){delete z.parseinfo}}for(aa in ar.names){if(ar.names[aa]){X=ar.names[aa].definition;T="";if(X.charAt(0)=="="){T="=";X=X.substring(1)}ar.names[aa].definition=T+SocialCalc.AdjustFormulaCoords(X,k.col,h,k.row,q)}}for(ai=g.lastrow;ai>=I&&af=="insertrow";ai--){n=ai+q;for(l in ar.rowattribs){aA=ar.rowattribs[l][ai];if(ar.rowattribs[l][n]!=aA){if(aA){ar.rowattribs[l][n]=aA}else{delete ar.rowattribs[l][n]}}}}for(y=g.lastcol;y>=ak&&af=="insertcol";y--){G=SocialCalc.rcColname(y);au=SocialCalc.rcColname(y+h);for(l in ar.colattribs){aA=ar.colattribs[l][G];if(ar.colattribs[l][au]!=aA){if(aA){ar.colattribs[l][au]=aA}else{delete ar.colattribs[l][au]}}}}g.lastcol+=h;g.lastrow+=q;g.needsrecalc="yes";break;case"deletecol":case"deleterow":ar.renderneeded=true;ar.changedrendervalues=true;O=ae.NextToken();R=ae.RestOfString();U=g.lastcol;b=g.lastrow;Y();if(af=="deletecol"){h=k.col-j.col-1;q=0;M=j.col+1;f=1}else{h=0;q=k.row-j.row-1;M=1;f=j.row+1}for(ai=f;ai<=b-q;ai++){for(y=M;y<=U-h;y++){A=SocialCalc.crToCoord(y+h,ai+q);if(N&&(ai<f-q||y<M-h)){z=ar.cells[A];if(!z){at.AddUndo("erase "+A+" all")}else{at.AddUndo("set "+A+" all",ar.CellToString(z))}}u=SocialCalc.crToCoord(y,ai);z=ar.cells[u];if(!z){delete ar.cells[A]}else{ar.cells[A]=z}}}for(A in ar.cells){z=ar.cells[A];if(z){if(z.datatype=="f"){al=z.formula;z.formula=SocialCalc.AdjustFormulaCoords(al,k.col,h,k.row,q);if(z.formula!=al){delete z.parseinfo;if(N&&z.formula.indexOf("#REF!")!=-1){e=SocialCalc.coordToCr(A);at.AddUndo("set "+SocialCalc.rcColname(e.col-h)+(e.row-q)+" formula "+al)}}}else{delete z.parseinfo}}}for(aa in ar.names){if(ar.names[aa]){X=ar.names[aa].definition;T="";if(X.charAt(0)=="="){T="=";X=X.substring(1)}ar.names[aa].definition=T+SocialCalc.AdjustFormulaCoords(X,k.col,h,k.row,q)}}for(ai=f;ai<=b-q&&af=="deleterow";ai++){H=ai+q;for(l in ar.rowattribs){aA=ar.rowattribs[l][ai];if(ar.rowattribs[l][H]!=aA){if(N){at.AddUndo("set "+H+" "+l,ar.rowattribs[l][H])}if(aA){ar.rowattribs[l][H]=aA}else{delete ar.rowattribs[l][H]}}}}for(y=M;y<=U-h&&af=="deletecol";y++){G=SocialCalc.rcColname(y);D=SocialCalc.rcColname(y+h);for(l in ar.colattribs){aA=ar.colattribs[l][G];if(ar.colattribs[l][D]!=aA){if(N){at.AddUndo("set "+D+" "+l,ar.colattribs[l][D])}if(aA){ar.colattribs[l][D]=aA}else{delete ar.colattribs[l][D]}}}}if(N){if(af=="deletecol"){for(y=k.col;y<=j.col;y++){at.AddUndo("insertcol "+SocialCalc.rcColname(y))}}else{for(ai=k.row;ai<=j.row;ai++){at.AddUndo("insertrow "+ai)}}}if(af=="deletecol"){if(k.col<=U){if(j.col<=U){g.lastcol+=h}else{g.lastcol=k.col-1}}}else{if(k.row<=b){if(j.row<=b){g.lastrow+=q}else{g.lastrow=k.row-1}}}g.needsrecalc="yes";break;case"movepaste":case"moveinsert":var aw,m,t,P,J,W,ag;ar.renderneeded=true;ar.changedrendervalues=true;if(N){at.AddUndo("changedrendervalues")}O=ae.NextToken();m=ae.NextToken();R=ae.RestOfString();if(R==""){R="all"}Y();t=SocialCalc.coordToCr(m);h=t.col-k.col;q=t.row-k.row;aB=j.col-k.col+1;Z=j.row-k.row+1;aw={};for(ai=k.row;ai<=j.row;ai++){for(y=k.col;y<=j.col;y++){A=SocialCalc.crToCoord(y,ai);z=ar.GetAssuredCell(A);if(N){at.AddUndo("set "+A+" all",ar.CellToString(z))}if(!ar.cells[A]){continue}aw[A]=new SocialCalc.Cell(A);for(l in v){if(typeof z[l]===undefined){continue}else{aw[A][l]=z[l]}if(R=="all"){delete z[l]}if(R=="formulas"){if(v[l]==1||v[l]==3){delete z[l]}}if(R=="formats"){if(v[l]==2){delete z[l]}}}if(R=="formulas"){z.datavalue="";z.datatype=null;z.formula="";z.valuetype="b"}if(R=="all"){delete ar.cells[A]}}}if(af=="moveinsert"){P=false;J=false;if(q==0&&(t.col<k.col||t.col>j.col)){if(t.col<k.col){W=k.col-t.col;P=-1}else{t.col-=1;h=t.col-j.col;W=t.col-j.col;P=1}}else{if(h==0&&(t.row<k.row||t.row>j.row)){if(t.row<k.row){W=k.row-t.row;J=-1}else{t.row-=1;q=t.row-j.row;W=t.row-j.row;J=1}}else{af="movepaste"}}}ag={};if(J){for(ai=0;ai<W;ai++){for(y=k.col;y<=j.col;y++){if(J<0){u=SocialCalc.crToCoord(y,t.row+W-ai-1);A=SocialCalc.crToCoord(y,j.row-ai)}else{u=SocialCalc.crToCoord(y,t.row-W+ai+1);A=SocialCalc.crToCoord(y,k.row+ai)}ab=ar.GetAssuredCell(u);if(N){at.AddUndo("set "+u+" all",ar.CellToString(ab))}z=ar.GetAssuredCell(A);if(R=="all"||R=="formats"){for(l in v){if(v[l]==1){continue}if(typeof ab[l]===undefined||v[l]==3){delete z[l]}else{z[l]=ab[l]}}}if(R=="all"||R=="formulas"){z.datavalue=ab.datavalue;z.datatype=ab.datatype;z.valuetype=ab.valuetype;z.formula=ab.formula;delete z.parseinfo;z.errors=ab.errors}delete z.displaystring;ag[u]=A}}}if(P){for(y=0;y<W;y++){for(ai=k.row;ai<=j.row;ai++){if(P<0){u=SocialCalc.crToCoord(t.col+W-y-1,ai);A=SocialCalc.crToCoord(j.col-y,ai)}else{u=SocialCalc.crToCoord(t.col-W+y+1,ai);A=SocialCalc.crToCoord(k.col+y,ai)}ab=ar.GetAssuredCell(u);if(N){at.AddUndo("set "+u+" all",ar.CellToString(ab))}z=ar.GetAssuredCell(A);if(R=="all"||R=="formats"){for(l in v){if(v[l]==1){continue}if(typeof ab[l]===undefined||v[l]==3){delete z[l]}else{z[l]=ab[l]}}}if(R=="all"||R=="formulas"){z.datavalue=ab.datavalue;z.datatype=ab.datatype;z.valuetype=ab.valuetype;z.formula=ab.formula;delete z.parseinfo;z.errors=ab.errors}delete z.displaystring;ag[u]=A}}}if(t.col+aB-1>g.lastcol){g.lastcol=t.col+aB-1}if(t.row+Z-1>g.lastrow){g.lastrow=t.row+Z-1}for(ai=k.row;ai<k.row+Z;ai++){for(y=k.col;y<k.col+aB;y++){A=SocialCalc.crToCoord(y+h,ai+q);z=ar.GetAssuredCell(A);if(N){at.AddUndo("set "+A+" all",ar.CellToString(z))}u=SocialCalc.crToCoord(y,ai);ag[u]=A;if(R=="all"&&!aw[u]){delete ar.cells[A];continue}ab=aw[u];if(!ab){ab=ar.GetAssuredCell(u)}if(R=="all"||R=="formats"){for(l in v){if(v[l]==1){continue}if(typeof ab[l]===undefined||v[l]==3){delete z[l]}else{z[l]=ab[l]}}}if(R=="all"||R=="formulas"){z.datavalue=ab.datavalue;z.datatype=ab.datatype;z.valuetype=ab.valuetype;z.formula=ab.formula;delete z.parseinfo;z.errors=ab.errors;if(ab.comment){z.comment=ab.comment}else{if(z.comment){delete z.comment}}}delete z.displaystring}}for(A in ar.cells){z=ar.cells[A];if(z){if(z.datatype=="f"){al=z.formula;z.formula=SocialCalc.ReplaceFormulaCoords(al,ag);if(z.formula!=al){delete z.parseinfo;if(N&&!ag[A]){at.AddUndo("set "+A+" formula "+al)}}}else{delete z.parseinfo}}}for(aa in ar.names){if(ar.names[aa]){X=ar.names[aa].definition;al=X;T="";if(X.charAt(0)=="="){T="=";X=X.substring(1)}ar.names[aa].definition=T+SocialCalc.ReplaceFormulaCoords(X,ag);if(N&&ar.names[aa].definition!=al){at.AddUndo("name define "+aa+" "+al)}}}g.needsrecalc="yes";break;case"name":O=ae.NextToken();aa=ae.NextToken();R=ae.RestOfString();aa=aa.toUpperCase().replace(/[^A-Z0-9_\.]/g,"");if(aa==""){break}if(O=="define"){if(R==""){break}if(ar.names[aa]){if(N){at.AddUndo("name define "+aa+" "+ar.names[aa].definition)}ar.names[aa].definition=R}else{if(N){at.AddUndo("name delete "+aa)}ar.names[aa]={definition:R,desc:""}}}else{if(O=="desc"){if(ar.names[aa]){if(N){at.AddUndo("name desc "+aa+" "+ar.names[aa].desc)}ar.names[aa].desc=R}}else{if(O=="delete"){if(N){if(ar.names[aa].desc){at.AddUndo("name desc "+aa+" "+ar.names[aa].desc)}at.AddUndo("name define "+aa+" "+ar.names[aa].definition)}delete ar.names[aa]}}}g.needsrecalc="yes";break;case"recalc":g.needsrecalc="yes";ar.recalconce=true;break;case"redisplay":ar.renderneeded=true;break;case"changedrendervalues":ar.changedrendervalues=true;break;case"startcmdextension":aa=ae.NextToken();C=SocialCalc.SheetCommandInfo.CmdExtensionCallbacks[aa];if(C){C.func(aa,C.data,ar,ae,N)}break;default:ah=am.s_escUnknownCmd+L;break}return ah};SocialCalc.SheetUndo=function(c){var b;var e=c.changes.TOS();var d=e?e.undo.length-1:-1;var a="";for(b=d;b>=0;b--){if(a){a+="\n"}a+=e.undo[b]}c.changes.Undo();c.ScheduleSheetCommands(a,false)};SocialCalc.SheetRedo=function(d){var e,c;var a=d.changes.Redo();if(!a){d.ScheduleSheetCommands("",false);return}e=d.changes.TOS();var b="";for(c=0;e&&c<e.command.length;c++){if(b){b+="\n"}b+=e.command[c]}d.ScheduleSheetCommands(b,false)};SocialCalc.CreateAuditString=function(e){var d,c;var b="";var a=e.changes.stack;var f=e.changes.tos;for(d=0;d<=f;d++){for(c=0;c<a[d].command.length;c++){b+=a[d].command[c]+"\n"}}return b};SocialCalc.GetStyleNum=function(c,b,d){var a;if(d.length==0){return 0}a=c[b+"hash"][d];if(!a){if(c[b+"s"].length<1){c[b+"s"].push("")}a=c[b+"s"].push(d)-1;c[b+"hash"][d]=a;c.changedrendervalues=true}return a};SocialCalc.GetStyleString=function(c,b,a){if(!a){return null}return c[b+"s"][a]};SocialCalc.OffsetFormulaCoords=function(k,n,c){var l,p,g,d,h,f;var b="";var a=SocialCalc.Formula;if(!a){return"Need SocialCalc.Formula"}var e=a.TokenType;var q=e.op;var j=e.string;var m=e.coord;var o=a.TokenOpExpansion;l=a.ParseFormulaIntoTokens(k);for(d=0;d<l.length;d++){g=l[d].type;p=l[d].text;if(g==m){f="";h=SocialCalc.coordToCr(p);if(p.charAt(0)!="$"){h.col+=n}else{f+="$"}f+=SocialCalc.rcColname(h.col);if(p.indexOf("$",1)==-1){h.row+=c}else{f+="$"}f+=h.row;if(h.row<1||h.col<1){f="#REF!"}b+=f}else{if(g==j){if(p.indexOf('"')>=0){b+='"'+p.replace(/"/,'""')+'"'}else{b+='"'+p+'"'}}else{if(g==q){b+=o[p]||p}else{b+=p}}}}return b};SocialCalc.AdjustFormulaCoords=function(k,b,m,r,d){var h,o,e,g;var c="";var p=false;var a=SocialCalc.Formula;if(!a){return"Need SocialCalc.Formula"}var f=a.TokenType;var q=f.op;var j=f.string;var l=f.coord;var n=a.TokenOpExpansion;parseinfo=SocialCalc.Formula.ParseFormulaIntoTokens(k);for(e=0;e<parseinfo.length;e++){h=parseinfo[e].type;o=parseinfo[e].text;if(h==q){if(o=="!"){p=true}else{if(o!=":"){p=false}}o=n[o]||o}if(h==l){cr=SocialCalc.coordToCr(o);if((m<0&&cr.col>=b&&cr.col<b-m)||(d<0&&cr.row>=r&&cr.row<r-d)){if(!p){cr.col=0;cr.row=0}}if(!p){if(cr.col>=b){cr.col+=m}if(cr.row>=r){cr.row+=d}}if(o.charAt(0)=="$"){g="$"+SocialCalc.rcColname(cr.col)}else{g=SocialCalc.rcColname(cr.col)}if(o.indexOf("$",1)!=-1){g+="$"+cr.row}else{g+=cr.row}if(cr.row<1||cr.col<1){g="#REF!"}o=g}else{if(h==j){if(o.indexOf('"')>=0){o='"'+o.replace(/"/,'""')+'"'}else{o='"'+o+'"'}}}c+=o}return c};SocialCalc.ReplaceFormulaCoords=function(k,b){var h,n,d,g,f;var c="";var o=false;var a=SocialCalc.Formula;if(!a){return"Need SocialCalc.Formula"}var e=a.TokenType;var p=e.op;var j=e.string;var l=e.coord;var m=a.TokenOpExpansion;parseinfo=SocialCalc.Formula.ParseFormulaIntoTokens(k);for(d=0;d<parseinfo.length;d++){h=parseinfo[d].type;n=parseinfo[d].text;if(h==p){if(n=="!"){o=true}else{if(n!=":"){o=false}}n=m[n]||n}if(h==l){cr=SocialCalc.coordToCr(n);f=SocialCalc.crToCoord(cr.col,cr.row);if(b[f]&&!o){cr=SocialCalc.coordToCr(b[f]);if(n.charAt(0)=="$"){g="$"+SocialCalc.rcColname(cr.col)}else{g=SocialCalc.rcColname(cr.col)}if(n.indexOf("$",1)!=-1){g+="$"+cr.row}else{g+=cr.row}n=g}}else{if(h==j){if(n.indexOf('"')>=0){n='"'+n.replace(/"/,'""')+'"'}else{n='"'+n+'"'}}}c+=n}return c};SocialCalc.RecalcInfo={sheet:null,currentState:0,state:{start_calc:1,order:2,calc:3,start_wait:4,done_wait:5},recalctimer:null,maxtimeslice:100,timeslicedelay:1,starttime:0,LoadSheet:function(a){return false}};SocialCalc.RecalcData=function(){this.inrecalc=true;this.celllist=[];this.celllistitem=0;this.calclist=null;this.calclistlength=0;this.firstcalc=null;this.lastcalc=null;this.nextcalc=null;this.count=0;this.checkinfo={}};SocialCalc.RecalcCheckInfo=function(){this.oldcoord=null;this.parsepos=0;this.inrange=false;this.inrangestart=false;this.cr1=null;this.cr2=null;this.c1=null;this.c2=null;this.r1=null;this.r2=null;this.c=null;this.r=null};SocialCalc.RecalcSheet=function(a){var e,b,d;var c=SocialCalc.RecalcInfo;delete a.attribs.circularreferencecell;SocialCalc.Formula.FreshnessInfoReset();SocialCalc.RecalcClearTimeout();c.sheet=a;c.currentState=c.state.start_calc;c.starttime=new Date();if(a.statuscallback){a.statuscallback(c,"calcstart",null,a.statuscallbackparams)}SocialCalc.RecalcSetTimeout()};SocialCalc.RecalcSetTimeout=function(){var a=SocialCalc.RecalcInfo;a.recalctimer=window.setTimeout(SocialCalc.RecalcTimerRoutine,a.timeslicedelay)};SocialCalc.RecalcClearTimeout=function(){var a=SocialCalc.RecalcInfo;if(a.recalctimer){window.clearTimeout(a.recalctimer);a.recalctimer=null}};SocialCalc.RecalcLoadedSheet=function(c,f,e){var a;var b=SocialCalc.RecalcInfo;var d=SocialCalc.Formula;a=SocialCalc.Formula.AddSheetToCache(c||d.SheetCache.waitingForLoading,f);if(e&&a&&a.attribs.recalc!="off"){a.previousrecalcsheet=b.sheet;b.sheet=a;b.currentState=b.state.start_calc}d.SheetCache.waitingForLoading=null;SocialCalc.RecalcSetTimeout()};SocialCalc.RecalcTimerRoutine=function(){var l,m,g,e,f;var k=new Date();var h=0;var a=SocialCalc.Formula;if(!a){return"Need SocialCalc.Formula"}var c=SocialCalc.RecalcInfo;var j=c.sheet;if(!j){return}var d=j.recalcdata;var b=function(o,n){if(j.statuscallback){j.statuscallback(d,o,n,j.statuscallbackparams)}};SocialCalc.RecalcClearTimeout();if(c.currentState==c.state.start_calc){d=new SocialCalc.RecalcData();j.recalcdata=d;for(g in j.cells){if(!g){continue}d.celllist.push(g)}d.calclist={};c.currentState=c.state.order}if(c.currentState==c.state.order){while(d.celllistitem<d.celllist.length){g=d.celllist[d.celllistitem++];e=SocialCalc.RecalcCheckCell(j,g);if(((new Date())-k)>=c.maxtimeslice){b("calcorder",{coord:g,total:d.celllist.length,count:d.celllistitem});SocialCalc.RecalcSetTimeout();return}}b("calccheckdone",d.calclistlength);d.nextcalc=d.firstcalc;c.currentState=c.state.calc;SocialCalc.RecalcSetTimeout();return}if(c.currentState==c.state.start_wait){c.currentState=c.state.done_wait;if(c.LoadSheet){f=c.LoadSheet(a.SheetCache.waitingForLoading);if(f){return}}SocialCalc.RecalcLoadedSheet(null,"",false);return}if(c.currentState==c.state.done_wait){c.currentState=c.state.calc;SocialCalc.RecalcSetTimeout();return}if(c.currentState!=c.state.calc){alert("Recalc state error: "+c.currentState+". Error in SocialCalc code.")}g=j.recalcdata.nextcalc;while(g){m=j.cells[g];l=a.evaluate_parsed_formula(m.parseinfo,j,false);if(a.SheetCache.waitingForLoading){d.nextcalc=g;d.count+=h;b("calcloading",{sheetname:a.SheetCache.waitingForLoading});c.currentState=c.state.start_wait;SocialCalc.RecalcSetTimeout();return}if(a.RemoteFunctionInfo.waitingForServer){d.nextcalc=g;d.count+=h;b("calcserverfunc",{funcname:a.RemoteFunctionInfo.waitingForServer,coord:g,total:d.calclistlength,count:d.count});c.currentState=c.state.done_wait;return}if(m.datavalue!=l.value||m.valuetype!=l.type){m.datavalue=l.value;m.valuetype=l.type;delete m.displaystring;j.recalcchangedavalue=true}if(l.error){m.errors=l.error}h++;g=j.recalcdata.calclist[g];if(((new Date())-k)>=c.maxtimeslice){d.nextcalc=g;d.count+=h;b("calcstep",{coord:g,total:d.calclistlength,count:d.count});SocialCalc.RecalcSetTimeout();return}}d.inrecalc=false;delete j.recalcdata;delete j.attribs.needsrecalc;c.sheet=j.previousrecalcsheet||null;if(c.sheet){c.currentState=c.state.calc;SocialCalc.RecalcSetTimeout();return}a.FreshnessInfo.recalc_completed=true;b("calcfinished",(new Date())-c.starttime)};SocialCalc.RecalcCheckCell=function(g,m){var u,b,v,w,c,j,q,h,e,a,p;var d=SocialCalc.Formula;if(!d){return"Need SocialCalc.Formula"}var t=d.TokenType;var o=t.op;var k=t.name;var s=t.coord;var f=g.recalcdata;var x=f.checkinfo;var n=false;var l=null;var r=m;mainloop:while(r){a=g.cells[r];p=x[r];if(!a||a.datatype!="f"||(p&&typeof p!="object")){r=l;if(x[r]){l=x[r].oldcoord}continue}if(!p){p=new SocialCalc.RecalcCheckInfo();x[r]=p}if(a.errors){delete a.errors}if(!a.parseinfo){a.parseinfo=d.ParseFormulaIntoTokens(a.formula)}u=a.parseinfo;for(w=p.parsepos;w<u.length;w++){if(p.inrange){if(p.inrangestart){if(p.cr1.col>p.cr2.col){p.c1=p.cr2.col;p.c2=p.cr1.col}else{p.c1=p.cr1.col;p.c2=p.cr2.col}p.c=p.c1-1;if(p.cr1.row>p.cr2.row){p.r1=p.cr2.row;p.r2=p.cr1.row}else{p.r1=p.cr1.row;p.r2=p.cr2.row}p.r=p.r1;p.inrangestart=false}else{}p.c+=1;if(p.c>p.c2){p.r+=1;if(p.r>p.r2){p.inrange=false;continue}p.c=p.c1}c=SocialCalc.crToCoord(p.c,p.r);p.parsepos=w;p.oldcoord=l;l=r;r=c;if(x[r]&&typeof x[r]=="object"){a.errors=SocialCalc.Constants.s_caccCircRef+m;x[m]=true;if(!f.firstcalc){f.firstcalc=m}else{f.calclist[f.lastcalc]=m}f.lastcalc=m;f.calclistlength++;g.attribs.circularreferencecell=r+"|"+l;return a.errors}continue mainloop}v=u[w].type;b=u[w].text;if(v==o){if(b=="!"){n=true}else{if(b!=":"){n=false}}}if(v==k){q=d.LookupName(g,b);if(q.type=="range"){h=q.value.indexOf("|");if(h!=-1){p.cr1=SocialCalc.coordToCr(q.value.substring(0,h));e=q.value.indexOf("|",h+1);p.cr2=SocialCalc.coordToCr(q.value.substring(h+1,e));p.inrange=true;p.inrangestart=true;w=w-1;continue}}else{if(q.type=="coord"){v=s;b=q.value}else{}}}if(v==s){if(w>=2&&u[w-1].type==o&&u[w-1].text==":"&&u[w-2].type==s&&!n){p.cr1=SocialCalc.coordToCr(u[w-2].text);p.cr2=SocialCalc.coordToCr(b);p.inrange=true;p.inrangestart=true;w=w-1;continue}else{if(!n){if(b.indexOf("$")!=-1){b=b.replace(/\$/g,"")}p.parsepos=w+1;p.oldcoord=l;l=r;r=b;if(x[r]&&typeof x[r]=="object"){a.errors=SocialCalc.Constants.s_caccCircRef+m;x[m]=true;if(!f.firstcalc){f.firstcalc=m}else{f.calclist[f.lastcalc]=m}f.lastcalc=m;f.calclistlength++;g.attribs.circularreferencecell=r+"|"+l;return a.errors}continue mainloop}}}}n=false;x[r]=true;if(!f.firstcalc){f.firstcalc=r}else{f.calclist[f.lastcalc]=r}f.lastcalc=r;f.calclistlength++;r=l;l=x[r]?x[r].oldcoord:null}return""};SocialCalc.Parse=function(a){this.str=a;this.pos=0;this.delimiter=" ";this.lineEnd=a.indexOf("\n");if(this.lineEnd<0){this.lineEnd=a.length}};SocialCalc.Parse.prototype.NextToken=function(){if(this.pos<0){return""}var a=this.str.indexOf(this.delimiter,this.pos);var b=this.pos;if(a>this.lineEnd){a=this.lineEnd}if(a>=0){this.pos=a+1;return this.str.substring(b,a)}else{this.pos=this.lineEnd;return this.str.substring(b,this.lineEnd)}};SocialCalc.Parse.prototype.RestOfString=function(){var a=this.pos;if(this.pos<0||this.pos>=this.lineEnd){return""}this.pos=this.lineEnd;return this.str.substring(a,this.lineEnd)};SocialCalc.Parse.prototype.RestOfStringNoMove=function(){if(this.pos<0||this.pos>=this.lineEnd){return""}return this.str.substring(this.pos,this.lineEnd)};SocialCalc.Parse.prototype.NextLine=function(){this.pos=this.lineEnd+1;this.lineEnd=this.str.indexOf("\n",this.pos);if(this.lineEnd<0){this.lineEnd=this.str.length}};SocialCalc.Parse.prototype.EOF=function(){if(this.pos<0||this.pos>=this.str.length){return true}return false};SocialCalc.UndoStack=function(){this.stack=[];this.tos=-1;this.maxRedo=0;this.maxUndo=50};SocialCalc.UndoStack.prototype.PushChange=function(a){while(this.stack.length>0&&this.stack.length-1>this.tos){this.stack.pop()}this.stack.push({command:[],type:a,undo:[]});if(this.maxRedo&&this.stack.length>this.maxRedo){this.stack.shift()}if(this.maxUndo&&this.stack.length>this.maxUndo){this.stack[this.stack.length-this.maxUndo-1].undo=[]}this.tos=this.stack.length-1};SocialCalc.UndoStack.prototype.AddDo=function(){var a=[];for(var b=0;b<arguments.length;b++){if(arguments[b]!=null){a.push(arguments[b])}}var c=a.join(" ");this.stack[this.stack.length-1].command.push(c)};SocialCalc.UndoStack.prototype.AddUndo=function(){var a=[];for(var b=0;b<arguments.length;b++){if(arguments[b]!=null){a.push(arguments[b])}}var c=a.join(" ");this.stack[this.stack.length-1].undo.push(c)};SocialCalc.UndoStack.prototype.TOS=function(){if(this.tos>=0){return this.stack[this.tos]}else{return null}};SocialCalc.UndoStack.prototype.Undo=function(){if(this.tos>=0&&(!this.maxUndo||this.tos>this.stack.length-this.maxUndo-1)){this.tos-=1;return true}else{return false}};SocialCalc.UndoStack.prototype.Redo=function(){if(this.tos<this.stack.length-1){this.tos+=1;return true}else{return false}};SocialCalc.Clipboard={clipboard:""};SocialCalc.RenderContext=function(f){var d,b,c;var e=f.attribs;var a=SocialCalc.Constants;this.sheetobj=f;this.hideRowsCols=false;this.showGrid=false;this.showRCHeaders=false;this.rownamewidth=a.defaultRowNameWidth;this.pixelsPerRow=a.defaultAssumedRowHeight;this.cellskip={};this.coordToCR={};this.colwidth=[];this.totalwidth=0;this.rowpanes=[];this.colpanes=[];this.maxcol=0;this.maxrow=0;this.highlights={};this.cursorsuffix="";this.highlightTypes={cursor:{style:a.defaultHighlightTypeCursorStyle,className:a.defaultHighlightTypeCursorClass},range:{style:a.defaultHighlightTypeRangeStyle,className:a.defaultHighlightTypeRangeClass},cursorinsertup:{style:"color:#FFF;backgroundColor:#A6A6A6;backgroundRepeat:repeat-x;backgroundPosition:top left;backgroundImage:url("+a.defaultImagePrefix+"cursorinsertup.gif);",className:a.defaultHighlightTypeCursorClass},cursorinsertleft:{style:"color:#FFF;backgroundColor:#A6A6A6;backgroundRepeat:repeat-y;backgroundPosition:top left;backgroundImage:url("+a.defaultImagePrefix+"cursorinsertleft.gif);",className:a.defaultHighlightTypeCursorClass},range2:{style:"color:#000;backgroundColor:#FFF;backgroundImage:url("+a.defaultImagePrefix+"range2.gif);",className:""}};this.cellIDprefix=a.defaultCellIDPrefix;this.defaultlinkstyle=null;this.defaultHTMLlinkstyle={type:"html"};this.defaultfontstyle=a.defaultCellFontStyle;this.defaultfontsize=a.defaultCellFontSize;this.defaultfontfamily=a.defaultCellFontFamily;this.defaultlayout=a.defaultCellLayout;this.defaultpanedividerwidth=a.defaultPaneDividerWidth;this.defaultpanedividerheight=a.defaultPaneDividerHeight;this.gridCSS=a.defaultGridCSS;this.commentClassName=a.defaultCommentClass;this.commentCSS=a.defaultCommentStyle;this.commentNoGridClassName=a.defaultCommentNoGridClass;this.commentNoGridCSS=a.defaultCommentNoGridStyle;this.classnames={colname:a.defaultColnameClass,rowname:a.defaultRownameClass,selectedcolname:a.defaultSelectedColnameClass,selectedrowname:a.defaultSelectedRownameClass,upperleft:a.defaultUpperLeftClass,skippedcell:a.defaultSkippedCellClass,panedivider:a.defaultPaneDividerClass};this.explicitStyles={colname:a.defaultColnameStyle,rowname:a.defaultRownameStyle,selectedcolname:a.defaultSelectedColnameStyle,selectedrowname:a.defaultSelectedRownameStyle,upperleft:a.defaultUpperLeftStyle,skippedcell:a.defaultSkippedCellStyle,panedivider:a.defaultPaneDividerStyle};this.cellskip=null;this.needcellskip=true;this.fonts=[];this.layouts=[];this.needprecompute=true;if(f){this.rowpanes[0]={first:1,last:e.lastrow};this.colpanes[0]={first:1,last:e.lastcol}}else{throw a.s_rcMissingSheet}};SocialCalc.RenderContext.prototype.PrecomputeSheetFontsAndLayouts=function(){SocialCalc.PrecomputeSheetFontsAndLayouts(this)};SocialCalc.RenderContext.prototype.CalculateCellSkipData=function(){SocialCalc.CalculateCellSkipData(this)};SocialCalc.RenderContext.prototype.CalculateColWidthData=function(){SocialCalc.CalculateColWidthData(this)};SocialCalc.RenderContext.prototype.SetRowPaneFirstLast=function(c,b,a){this.rowpanes[c]={first:b,last:a}};SocialCalc.RenderContext.prototype.SetColPaneFirstLast=function(c,b,a){this.colpanes[c]={first:b,last:a}};SocialCalc.RenderContext.prototype.CoordInPane=function(c,a,b){return SocialCalc.CoordInPane(this,c,a,b)};SocialCalc.RenderContext.prototype.CellInPane=function(d,b,a,c){return SocialCalc.CellInPane(this,d,b,a,c)};SocialCalc.RenderContext.prototype.InitializeTable=function(a){SocialCalc.InitializeTable(this,a)};SocialCalc.RenderContext.prototype.RenderSheet=function(a,b){return SocialCalc.RenderSheet(this,a,b)};SocialCalc.RenderContext.prototype.RenderColGroup=function(){return SocialCalc.RenderColGroup(this)};SocialCalc.RenderContext.prototype.RenderColHeaders=function(){return SocialCalc.RenderColHeaders(this)};SocialCalc.RenderContext.prototype.RenderSizingRow=function(){return SocialCalc.RenderSizingRow(this)};SocialCalc.RenderContext.prototype.RenderRow=function(b,a,c){return SocialCalc.RenderRow(this,b,a,c)};SocialCalc.RenderContext.prototype.RenderSpacingRow=function(){return SocialCalc.RenderSpacingRow(this)};SocialCalc.RenderContext.prototype.RenderCell=function(b,e,a,c,d,f){return SocialCalc.RenderCell(this,b,e,a,c,d,f)};SocialCalc.PrecomputeSheetFontsAndLayouts=function(d){var k,e,f,c,j,h,l,g;var b=d.sheetobj;var a=b.attribs;if(a.defaultfont){k=b.fonts[a.defaultfont];k=k.replace(/^\*/,SocialCalc.Constants.defaultCellFontStyle);k=k.replace(/(.+)\*(.+)/,"$1"+SocialCalc.Constants.defaultCellFontSize+"$2");k=k.replace(/\*$/,SocialCalc.Constants.defaultCellFontFamily);e=k.match(/^(\S+? \S+?) (\S+?) (\S.*)$/);d.defaultfontstyle=e[1];d.defaultfontsize=e[2];d.defaultfontfamily=e[3]}for(h=1;h<b.fonts.length;h++){l=b.fonts[h];l=l.replace(/^\*/,d.defaultfontstyle);l=l.replace(/(.+)\*(.+)/,"$1"+d.defaultfontsize+"$2");l=l.replace(/\*$/,d.defaultfontfamily);e=l.match(/^(\S+?) (\S+?) (\S+?) (\S.*)$/);d.fonts[h]={style:e[1],weight:e[2],size:e[3],family:e[4]}}f=/^padding:\s*(\S+)\s+(\S+)\s+(\S+)\s+(\S+);vertical-align:\s*(\S+);/;c=SocialCalc.Constants.defaultCellLayout.match(f);if(a.defaultlayout){j=b.layouts[a.defaultlayout].match(f)}else{j=["","*","*","*","*","*"]}for(h=1;h<b.layouts.length;h++){l=b.layouts[h];e=l.match(f);for(g=1;g<=5;g++){if(e[g]=="*"){e[g]=(j[g]!="*"?j[g]:c[g])}}d.layouts[h]="padding:"+e[1]+" "+e[2]+" "+e[3]+" "+e[4]+";vertical-align:"+e[5]+";"}d.needprecompute=false};SocialCalc.CalculateCellSkipData=function(b){var o,d,j,m,l,c,h,k,n,f;var a=b.sheetobj;var g=a.rowattribs;var e=a.colattribs;b.maxrow=0;b.maxcol=0;b.cellskip={};for(o=1;o<=a.attribs.lastrow;o++){for(d=1;d<=a.attribs.lastcol;d++){j=SocialCalc.crToCoord(d,o);m=a.cells[j];if(m===undefined||b.cellskip[j]){continue}c=m.colspan||1;h=m.rowspan||1;if(c>1||h>1){for(k=o;k<o+h;k++){for(n=d;n<d+c;n++){f=SocialCalc.crToCoord(n,k);if(f==j){b.coordToCR[j]={row:o,col:d}}else{b.cellskip[f]=j}if(k>b.maxrow){maxrow=k}if(n>b.maxcol){maxcol=n}}}}}}b.needcellskip=false};SocialCalc.CalculateColWidthData=function(b){var d,e,g,c;var f=b.sheetobj;var a=f.colattribs;c=b.showRCHeaders?b.rownamewidth-0:0;for(colpane=0;colpane<b.colpanes.length;colpane++){for(d=b.colpanes[colpane].first;d<=b.colpanes[colpane].last;d++){e=SocialCalc.rcColname(d);g=f.colattribs.width[e]||f.attribs.defaultcolwidth||SocialCalc.Constants.defaultColWidth;if(g=="blank"||g=="auto"){g=""}b.colwidth[d]=g+"";c+=(g&&((g-0)>0))?(g-0):10}}b.totalwidth=c};SocialCalc.InitializeTable=function(b,a){a.style.borderCollapse="collapse";a.cellSpacing="0";a.cellPadding="0";a.style.width=b.totalwidth+"px"};SocialCalc.RenderSheet=function(b,c,d){var h,g;var e,j,f,a;if(b.sheetobj.changedrendervalues){b.needcellskip=true;b.needprecompute=true;b.sheetobj.changedrendervalues=false}if(b.needcellskip){b.CalculateCellSkipData()}if(b.needprecompute){b.PrecomputeSheetFontsAndLayouts()}b.CalculateColWidthData();e=document.createElement("table");b.InitializeTable(e);j=b.RenderColGroup();e.appendChild(j);f=document.createElement("tbody");f.appendChild(b.RenderSizingRow());if(b.showRCHeaders){h=b.RenderColHeaders();if(h){f.appendChild(h)}}for(g=0;g<b.rowpanes.length;g++){for(rownum=b.rowpanes[g].first;rownum<=b.rowpanes[g].last;rownum++){h=b.RenderRow(rownum,g,d);f.appendChild(h)}if(g<b.rowpanes.length-1){h=b.RenderSpacingRow();f.appendChild(h)}}e.appendChild(f);if(c){a=c.parentNode;if(a){a.replaceChild(e,c)}}SocialCalc.EvalUserScripts();return e};SocialCalc.RenderRow=function(c,g,h,e){var b=c.sheetobj;var k=document.createElement("tr");var a,d,f,j;if(c.showRCHeaders){d=document.createElement("td");if(c.classnames){d.className=c.classnames.rowname}if(c.explicitStyles){d.style.cssText=c.explicitStyles.rowname}d.width=c.rownamewidth;d.style.verticalAlign="top";if(!SocialCalc.Constants.SCNoRowName){d.innerHTML=g+""}k.appendChild(d)}for(f=0;f<c.colpanes.length;f++){for(a=c.colpanes[f].first;a<=c.colpanes[f].last;a++){d=c.RenderCell(g,a,h,f,null,e);if(d){k.appendChild(d)}}if(f<c.colpanes.length-1){d=document.createElement("td");d.width=c.defaultpanedividerwidth;if(c.classnames.panedivider){d.className=c.classnames.panedivider}if(c.explicitStyles.panedivider){d.style.cssText=c.explicitStyles.panedivider}j=document.createElement("div");j.style.width=c.defaultpanedividerwidth+"px";j.style.overflow="hidden";d.appendChild(j);k.appendChild(d)}}return k};SocialCalc.RenderSpacingRow=function(e){var f,c,d,b;var g=e.sheetobj;var a=document.createElement("tr");if(e.showRCHeaders){c=document.createElement("td");c.width=e.rownamewidth;c.height=e.defaultpanedividerheight;if(e.classnames.panedivider){c.className=e.classnames.panedivider}if(e.explicitStyles.panedivider){c.style.cssText=e.explicitStyles.panedivider}a.appendChild(c)}for(d=0;d<e.colpanes.length;d++){for(f=e.colpanes[d].first;f<=e.colpanes[d].last;f++){c=document.createElement("td");b=e.colwidth[f];if(b){c.width=b}c.height=e.defaultpanedividerheight;if(e.classnames.panedivider){c.className=e.classnames.panedivider}if(e.explicitStyles.panedivider){c.style.cssText=e.explicitStyles.panedivider}if(c){a.appendChild(c)}}if(d<e.colpanes.length-1){c=document.createElement("td");c.width=e.defaultpanedividerwidth;c.height=e.defaultpanedividerheight;if(e.classnames.panedivider){c.className=e.classnames.panedivider}if(e.explicitStyles.panedivider){c.style.cssText=e.explicitStyles.panedivider}a.appendChild(c)}}return a};SocialCalc.RenderColHeaders=function(c){var e=c.sheetobj;var a=document.createElement("tr");var d,b;if(!c.showRCHeaders){return null}b=document.createElement("td");if(c.classnames){b.className=c.classnames.upperleft}if(c.explicitStyles){b.style.cssText=c.explicitStyles.upperleft}b.width=c.rownamewidth;a.appendChild(b);for(colpane=0;colpane<c.colpanes.length;colpane++){for(d=c.colpanes[colpane].first;d<=c.colpanes[colpane].last;d++){b=document.createElement("td");if(c.classnames){b.className=c.classnames.colname}if(c.explicitStyles){b.style.cssText=c.explicitStyles.colname}if(SocialCalc.Constants.SCNoColNames){}else{b.innerHTML=SocialCalc.rcColname(d)}a.appendChild(b)}if(colpane<c.colpanes.length-1){b=document.createElement("td");b.width=c.defaultpanedividerwidth;if(c.classnames.panedivider){b.className=c.classnames.panedivider}if(c.explicitStyles.panedivider){b.style.cssText=c.explicitStyles.panedivider}a.appendChild(b)}}return a};SocialCalc.RenderColGroup=function(e){var d,f,b,c;var g=e.sheetobj;var a=document.createElement("colgroup");if(e.showRCHeaders){b=document.createElement("col");b.width=e.rownamewidth;a.appendChild(b)}for(d=0;d<e.colpanes.length;d++){for(f=e.colpanes[d].first;f<=e.colpanes[d].last;f++){b=document.createElement("col");c=e.colwidth[f];if(c){b.width=c}a.appendChild(b)}if(d<e.colpanes.length-1){b=document.createElement("col");b.width=e.defaultpanedividerwidth;a.appendChild(b)}}return a};SocialCalc.RenderSizingRow=function(e){var d,f,b,c;var g=e.sheetobj;var a=document.createElement("tr");if(e.showRCHeaders){b=document.createElement("td");b.style.width=e.rownamewidth+"px";b.height="1";a.appendChild(b)}for(d=0;d<e.colpanes.length;d++){for(f=e.colpanes[d].first;f<=e.colpanes[d].last;f++){b=document.createElement("td");c=e.colwidth[f];if(c){b.width=c}b.height="1";a.appendChild(b)}if(d<e.colpanes.length-1){b=document.createElement("td");b.width=e.defaultpanedividerwidth;b.height="1";a.appendChild(b)}}return a};SocialCalc.RenderCell=function(e,k,b,q,s,a,m){var n=e.sheetobj;var g,j,h,p,r,c,d,l;var f="";k=k-0;b=b-0;var o=SocialCalc.crToCoord(b,k);if(e.cellskip[o]){if(e.CoordInPane(e.cellskip[o],q,s)){return null}h=a?SocialCalc.CreatePseudoElement():document.createElement("td");if(e.classnames.skippedcell){h.className=e.classnames.skippedcell}if(e.explicitStyles.skippedcell){h.style.cssText=e.explicitStyles.skippedcell}h.innerHTML="&nbsp;";return h}h=a?SocialCalc.CreatePseudoElement():document.createElement("td");if(e.cellIDprefix){h.id=e.cellIDprefix+o}c=n.cells[o];if(!c){c=new SocialCalc.Cell(o)}d=n.attribs;scc=SocialCalc.Constants;if(c.colspan>1){p=1;for(g=1;g<c.colspan;g++){if(n.colattribs.hide[SocialCalc.rcColname(b+g)]!="yes"&&e.CellInPane(k,b+g,q,s)){p++}}h.colSpan=p}if(c.rowspan>1){p=1;for(g=1;g<c.rowspan;g++){if(n.rowattribs.hide[(k+g)+""]!="yes"&&e.CellInPane(k+g,b,q,s)){p++}}h.rowSpan=p}if(c.displaystring==undefined){c.displaystring=SocialCalc.FormatValueForDisplay(n,c.datavalue,o,(m||e.defaultlinkstyle))}else{SocialCalc.CallOutOnRenderCell(n,c.datavalue,o)}h.innerHTML=c.displaystring;g=c.layout||d.defaultlayout;if(g){f+=e.layouts[g]}else{f+=scc.defaultCellLayout}g=c.font||d.defaultfont;if(g){j=e.fonts[g];f+="font-style:"+j.style+";font-weight:"+j.weight+";font-size:"+j.size+";font-family:"+j.family+";"}else{if(scc.defaultCellFontSize){f+="font-size:"+scc.defaultCellFontSize+";"}if(scc.defaultCellFontFamily){f+="font-family:"+scc.defaultCellFontFamily+";"}}g=c.color||d.defaultcolor;if(g){f+="color:"+n.colors[g]+";"}g=c.bgcolor||d.defaultbgcolor;if(g){f+="background-color:"+n.colors[g]+";"}g=c.cellformat;if(g){f+="text-align:"+n.cellformats[g]+";"}else{j=c.valuetype.charAt(0);if(j=="t"){g=d.defaulttextformat;if(g){f+="text-align:"+n.cellformats[g]+";"}}else{if(j="n"){g=d.defaultnontextformat;if(g){f+="text-align:"+n.cellformats[g]+";"}else{f+="text-align:right;"}}else{f+="text-align:left;"}}}g=c.bt;if(g){f+="border-top:"+n.borderstyles[g]+";"}g=c.br;if(g){f+="border-right:"+n.borderstyles[g]+";"}else{if(e.showGrid){if(e.CellInPane(k,b+(c.colspan||1),q,s)){j=SocialCalc.crToCoord(b+(c.colspan||1),k)}else{j="nomatch"}if(e.cellskip[j]){j=e.cellskip[j]}if(!n.cells[j]||!n.cells[j].bl){f+="border-right:"+e.gridCSS}}}g=c.bb;if(g){f+="border-bottom:"+n.borderstyles[g]+";"}else{if(e.showGrid){if(e.CellInPane(k+(c.rowspan||1),b,q,s)){j=SocialCalc.crToCoord(b,k+(c.rowspan||1))}else{j="nomatch"}if(e.cellskip[j]){j=e.cellskip[j]}if(!n.cells[j]||!n.cells[j].bt){f+="border-bottom:"+e.gridCSS}}}g=c.bl;if(g){f+="border-left:"+n.borderstyles[g]+";"}if(c.comment){if(e.showGrid){if(e.commentClassName){h.className=(h.className?h.className+" ":"")+e.commentClassName}f+=e.commentCSS}else{if(e.commentNoGridClassName){h.className=(h.className?h.className+" ":"")+e.commentNoGridClassName}f+=e.commentNoGridCSS}}h.style.cssText=f;j=e.highlights[o];if(j){if(j=="cursor"){j+=e.cursorsuffix}if(e.highlightTypes[j].className){h.className=(h.className?h.className+" ":"")+e.highlightTypes[j].className}if(j=="cursor"&&SocialCalc.Callbacks.IsCoordEditable&&!SocialCalc.Callbacks.IsCoordEditable(e.sheetobj.sheetname+"!"+o)){SocialCalc.setStyles(h,"")}else{SocialCalc.setStyles(h,e.highlightTypes[j].style)}}return h};SocialCalc.CoordInPane=function(d,e,a,c){var b=d.coordToCR[e];if(!b||!b.row||!b.col){throw"Bad coordToCR for "+e}return d.CellInPane(b.row,b.col,a,c)};SocialCalc.CellInPane=function(d,g,b,a,c){var e=d.rowpanes[a];var f=d.colpanes[c];if(!e||!f){throw"CellInPane called with unknown panes "+a+"/"+c}if(g<e.first||g>e.last){return false}if(b<f.first||b>f.last){return false}return true};SocialCalc.CreatePseudoElement=function(){return{style:{cssText:""},innerHTML:"",className:""}};SocialCalc.rcColname=function(d){if(d>702){d=702}if(d<1){d=1}var b=(d-1)%26+65;var a=Math.floor((d-1)/26);if(a){return String.fromCharCode(a+64)+String.fromCharCode(b)}else{return String.fromCharCode(b)}};SocialCalc.letters=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];SocialCalc.crToCoord=function(f,e){var a;if(f<1){f=1}if(f>702){f=702}if(e<1){e=1}var d=(f-1)%26;var b=Math.floor((f-1)/26);if(b){a=SocialCalc.letters[b-1]+SocialCalc.letters[d]+e}else{a=SocialCalc.letters[d]+e}return a};SocialCalc.coordToCol={};SocialCalc.coordToRow={};SocialCalc.coordToCr=function(e){var f,a,b;var d=SocialCalc.coordToRow[e];if(d){return{row:d,col:SocialCalc.coordToCol[e]}}f=0;d=0;for(a=0;a<e.length;a++){b=e.charCodeAt(a);if(b==36){}else{if(b<=57){d=10*d+b-48}else{if(b>=97){f=26*f+b-96}else{if(b>=65){f=26*f+b-64}}}}}SocialCalc.coordToCol[e]=f;SocialCalc.coordToRow[e]=d;return{row:d,col:f}};SocialCalc.ParseRange=function(c){var e,d,b,a;if(!c){c="A1:A1"}c=c.toUpperCase();e=c.indexOf(":");if(e>=0){d=c.substring(0,e);b=SocialCalc.coordToCr(d);b.coord=d;d=c.substring(e+1);a=SocialCalc.coordToCr(d);a.coord=d}else{b=SocialCalc.coordToCr(c);b.coord=c;a=SocialCalc.coordToCr(c);a.coord=c}return{cr1:b,cr2:a}};SocialCalc.decodeFromSave=function(a){if(typeof a!="string"){return a}if(a.indexOf("\\")==-1){return a}var b=a.replace(/\\c/g,":");b=b.replace(/\\n/g,"\n");return b.replace(/\\b/g,"\\")};SocialCalc.decodeFromAjax=function(a){if(typeof a!="string"){return a}if(a.indexOf("\\")==-1){return a}var b=a.replace(/\\c/g,":");b=b.replace(/\\n/g,"\n");b=b.replace(/\\e/g,"]]");return b.replace(/\\b/g,"\\")};SocialCalc.encodeForSave=function(a){if(typeof a!="string"){return a}if(a.indexOf("\\")!=-1){a=a.replace(/\\/g,"\\b")}if(a.indexOf(":")!=-1){a=a.replace(/:/g,"\\c")}if(a.indexOf("\n")!=-1){a=a.replace(/\n/g,"\\n")}return a};SocialCalc.special_chars=function(a){if(/[&<>"]/.test(a)){a=a.replace(/&/g,"&amp;");a=a.replace(/</g,"&lt;");a=a.replace(/>/g,"&gt;");a=a.replace(/"/g,"&quot;")}return a};SocialCalc.Lookup=function(b,a){for(i=0;i<a.length;i++){if(a[i]>b){if(i>0){return i-1}else{return null}}}return a.length-1};SocialCalc.setStyles=function(c,d){var f,b,g,a,e;if(!d){return}f=d.split(";");for(b=0;b<f.length;b++){g=f[b].indexOf(":");if(g!=-1){a=f[b].substring(0,g);e=f[b].substring(g+1);if(a&&e){c.style[a]=e}}}};SocialCalc.GetViewportInfo=function(){var a={};if(window.innerWidth){a.width=window.innerWidth;a.height=window.innerHeight;a.horizontalScroll=window.pageXOffset;a.verticalScroll=window.pageYOffset}else{if(document.documentElement&&document.documentElement.clientWidth){a.width=document.documentElement.clientWidth;a.height=document.documentElement.clientHeight;a.horizontalScroll=document.documentElement.scrollLeft;a.verticalScroll=document.documentElement.scrollTop}else{if(document.body.clientWidth){a.width=document.body.clientWidth;a.height=document.body.clientHeight;a.horizontalScroll=document.body.scrollLeft;a.verticalScroll=document.body.scrollTop}}}return a};SocialCalc.GetElementPosition=function(a){var c=0;var b=0;while(a){c+=a.offsetLeft;b+=a.offsetTop;a=a.offsetParent}return{left:c,top:b}};SocialCalc.GetElementPositionWithScroll=function(b){var d=0;var c=0;var a=b;while(b){if(b.tagName=="HTML"){break}if(b==a){d+=b.offsetLeft;c+=b.offsetTop;a=b.offsetParent}if(b.scrollLeft){d-=b.scrollLeft}if(b.scrollTop){c-=b.scrollTop}b=b.parentNode}return{left:d,top:c}};SocialCalc.LookupElement=function(b,c){var a;for(a=0;a<c.length;a++){if(c[a].element==b){return c[a]}}return null};SocialCalc.AssignID=function(b,a,c){if(b.idPrefix){a.id=b.idPrefix+c}};SocialCalc.GetCellContents=function(d,c){var a="";var b=d.cells[c];if(b){switch(b.datatype){case"v":a=b.datavalue+"";break;case"t":a="'"+b.datavalue;break;case"f":a="="+b.formula;break;case"c":a=b.formula;break;default:break}}return a};SocialCalc.FormatValueForDisplay=function(b,k,h,g){var d,f,j,n,e;var m;var a=b.attribs;var c=SocialCalc.Constants;var l=b.cells[h];if(!l){l=new SocialCalc.Cell(h)}m=k;n=l.valuetype||"";e=n.substring(1);n=n.charAt(0);if(l.errors||n=="e"){m=l.errors||e||"Error in cell";return m}if(n=="t"){d=b.valueformats[l.textvalueformat-0]||b.valueformats[a.defaulttextvalueformat-0]||"";if(d=="formula"){if(l.datatype=="f"){m=SocialCalc.special_chars("="+l.formula)||"&nbsp;"}else{if(l.datatype=="c"){m=SocialCalc.special_chars("'"+l.formula)||"&nbsp;"}else{m=SocialCalc.special_chars("'"+m)||"&nbsp;"}}return m}m=SocialCalc.format_text_for_display(m,l.valuetype,d,b,g);if(d=="text-html"){SocialCalc.ScriptCheck(b.sheetid,h,k)}}else{if(n=="n"){d=l.nontextvalueformat;if(d==null||d==""){d=a.defaultnontextvalueformat}d=b.valueformats[d-0];if(d==null||d=="none"){d=""}if(d=="formula"){if(l.datatype=="f"){m=SocialCalc.special_chars("="+l.formula)||"&nbsp;"}else{if(l.datatype=="c"){m=SocialCalc.special_chars("'"+l.formula)||"&nbsp;"}else{m=SocialCalc.special_chars("'"+m)||"&nbsp;"}}return m}else{if(d=="forcetext"){if(l.datatype=="f"){m=SocialCalc.special_chars("="+l.formula)||"&nbsp;"}else{if(l.datatype=="c"){m=SocialCalc.special_chars(l.formula)||"&nbsp;"}else{m=SocialCalc.special_chars(m)||"&nbsp;"}}return m}}m=SocialCalc.format_number_for_display(m,l.valuetype,d)}else{m="&nbsp;"}}return m};SocialCalc.format_text_for_display=function(h,k,b,a,g){var b,d,c,f,e;var j;d=k.substring(1);j=h;if(b=="none"||b==null){b=""}if(!/^(text-|custom|hidden)/.test(b)){b=""}if(b==""||b=="General"){if(d=="h"){b="text-html"}if(d=="w"||d=="r"){b="text-wiki"}if(d=="l"){b="text-link"}if(!d){b="text-plain"}}if(b=="text-html"){}else{if(SocialCalc.Callbacks.expand_wiki&&/^text-wiki/.test(b)){j=SocialCalc.Callbacks.expand_wiki(j,a,g,b)}else{if(b=="text-wiki"){j=SocialCalc.special_chars(j)}else{if(b=="text-wiki"){j=(SocialCalc.Callbacks.expand_markup&&SocialCalc.Callbacks.expand_markup(j,a,g))||SocialCalc.special_chars(j)}else{if(b=="text-url"){c=SocialCalc.special_chars(j);f=encodeURI(j);j='<a href="'+f+'">'+c+"</a>"}else{if(b=="text-link"){j=SocialCalc.expand_text_link(j,a,g,b)}else{if(b=="text-image"){f=encodeURI(j);j='<img src="'+f+'">'}else{if(b.substring(0,12)=="text-custom:"){c=SocialCalc.special_chars(j);c=c.replace(/  /g,"&nbsp; ");c=c.replace(/\n/g,"<br>");f=encodeURI(j);e={};e.r=j;e.s=c;e.u=f;j=b.substring(12);j=j.replace(/@(r|s|u)/g,function(l,m){return e[m]})}else{if(b.substring(0,6)=="custom"){j=SocialCalc.special_chars(j);j=j.replace(/  /g,"&nbsp; ");j=j.replace(/\n/g,"<br>");j+=" (custom format)"}else{if(b=="hidden"){j="&nbsp;"}else{j=SocialCalc.special_chars(j);j=j.replace(/  /g,"&nbsp; ");j=j.replace(/\n/g,"<br>")}}}}}}}}}}return j};SocialCalc.format_number_for_display=function(b,c,f){var d,e;var a=SocialCalc.Constants;d=b-0;e=c.substring(1);if(f=="Auto"||f==""){if(e=="%"){f="#,##0.0%"}else{if(e=="$"){f="[$]#,##0.00"}else{if(e=="dt"){f=a.defaultFormatdt}else{if(e=="d"){f=a.defaultFormatd}else{if(e=="t"){f=a.defaultFormatt}else{if(e=="l"){f="logical"}else{f="General"}}}}}}}if(f=="logical"){return d?a.defaultDisplayTRUE:a.defaultDisplayFALSE}if(f=="hidden"){return"&nbsp;"}return SocialCalc.FormatNumber.formatNumberWithFormat(b,f,"")};SocialCalc.DetermineValueType=function(h){var n=h+"";var k="t";var d,f,l,c,b,a,g,e,j,m;d=n.replace(/^\s+/,"");d=d.replace(/\s+$/,"");if(n.length==0){k=""}else{if(n.match(/^\s+$/)){}else{if(d.match(/^[-+]?\d*(?:\.)?\d*(?:[eE][-+]?\d+)?$/)){n=d-0;if(isNaN(n)){n=h+""}else{k="n"}}else{if(d.match(/^[-+]?\d*(?:\.)?\d*\s*%$/)){n=(d.slice(0,-1)-0)/100;k="n%"}else{if(d.match(/^[-+]?\$\s*\d*(?:\.)?\d*\s*$/)&&d.match(/\d/)){n=d.replace(/\$/,"")-0;k="n$"}else{if(d.match(/^[-+]?(\d*,\d*)+(?:\.)?\d*$/)){n=d.replace(/,/g,"")-0;k="n"}else{if(d.match(/^[-+]?(\d*,\d*)+(?:\.)?\d*\s*%$/)){n=(d.replace(/[%,]/g,"")-0)/100;k="n%"}else{if(d.match(/^[-+]?\$\s*(\d*,\d*)+(?:\.)?\d*$/)&&d.match(/\d/)){n=d.replace(/[\$,]/g,"")-0;k="n$"}else{if(f=n.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{1,4})\s*$/)){l=f[3]-0;l=l<1000?l+2000:l;n=SocialCalc.FormatNumber.convert_date_gregorian_to_julian(l,f[1]-0,f[2]-0)-2415019;k="nd"}else{if(f=n.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})\s*$/)){l=f[1]-0;l=l<1000?l+2000:l;n=SocialCalc.FormatNumber.convert_date_gregorian_to_julian(l,f[2]-0,f[3]-0)-2415019;k="nd"}else{if(f=n.match(/^(\d{1,2}):(\d{1,2})\s*$/)){c=f[1]-0;b=f[2]-0;if(c<24&&b<60){n=c/24+b/(24*60);k="nt"}}else{if(f=n.match(/^(\d{1,2}):(\d{1,2}):(\d{1,2})\s*$/)){c=f[1]-0;b=f[2]-0;a=f[3]-0;if(c<24&&b<60&&a<60){n=c/24+b/(24*60)+a/(24*60*60);k="nt"}}else{if(f=n.match(/^\s*([-+]?\d+) (\d+)\/(\d+)\s*$/)){j=f[1]-0;e=f[2]-0;g=f[3]-0;if(g&&g>0){n=j+(j<0?-e/g:e/g);k="n"}}else{if(m=SocialCalc.InputConstants[n.toUpperCase()]){e=m.indexOf(",");n=m.substring(0,e)-0;k=m.substring(e+1)}else{if(d.length>7&&d.substring(0,7).toLowerCase()=="http://"){n=d;k="tl"}}}}}}}}}}}}}}}return{value:n,type:k}};SocialCalc.InputConstants={TRUE:"1,nl",FALSE:"0,nl","#N/A":"0,e#N/A","#NULL!":"0,e#NULL!","#NUM!":"0,e#NUM!","#DIV/0!":"0,e#DIV/0!","#VALUE!":"0,e#VALUE!","#REF!":"0,e#REF!","#NAME?":"0,e#NAME?"};SocialCalc.default_expand_markup=function(b,d,c){var a=b;a=SocialCalc.special_chars(a);a=a.replace(/  /g,"&nbsp; ");a=a.replace(/\n/g,"<br>");return a;a=a.replace(/('*)'''(.*?)'''/g,"$1<b>$2</b>");a=a.replace(/''(.*?)''/g,"<i>$1</i>");return a};SocialCalc.expand_text_link=function(k,b,g,c){var h,f,j;var d=SocialCalc.Constants;var a="";var e=SocialCalc.ParseCellLinkText(k+"");if(e.desc){h=SocialCalc.special_chars(e.desc)}else{h=e.pagename?d.defaultPageLinkFormatString:d.defaultLinkFormatString}if(k.length>7&&k.substring(0,7).toLowerCase()=="http://"&&k.charAt(k.length-1)!=">"){h=h.substring(7)}f=(e.newwin||!g)?' target="_blank"':"";if(e.pagename){if(SocialCalc.Callbacks.MakePageLink){a=SocialCalc.Callbacks.MakePageLink(e.pagename,e.workspacename,g,c)}}else{a=encodeURI(e.url)}j='<a href="'+a+'"'+f+">"+h+"</a>";return j};SocialCalc.ParseCellLinkText=function(g){var j={url:"",desc:"",newwin:false,pagename:"",workspace:""};var e=false;var a=g.length-1;var h=0;var c=g.lastIndexOf("<");var d=g.lastIndexOf("[");var b=g.lastIndexOf("{");var f=-1;if((g.charAt(a)!=">"||c==-1)&&(g.charAt(a)!="]"||d==-1)&&(g.charAt(a)!="}"||g.charAt(a-1)!="]"||b==-1||d==-1||d<b)){a++;f=a}else{if(g.charAt(a)==">"){f=c-1;if(c>0&&g.charAt(f)=="<"&&g.charAt(a-1)==">"){f--;a--;j.newwin=true}}else{if(g.charAt(a)=="]"){f=d-1;e=true;if(d>0&&g.charAt(f)=="["&&g.charAt(a-1)=="]"){f--;a--;j.newwin=true}}else{if(g.charAt(a)=="}"){f=b-1;e=true;wsend=d;a--;if(d>0&&g.charAt(d-1)=="["&&g.charAt(a-1)=="]"){wsend=d-1;a--;j.newwin=true}if(g.charAt(wsend-1)==" "){wsend--}j.workspace=g.substring(b+1,wsend)||""}}}if(g.charAt(f)==" "){f--}if(g.charAt(h)=='"'&&g.charAt(f)=='"'){h++;f--}}if(e){j.pagename=g.substring(d+1,a)||""}else{j.url=g.substring(c+1,a)||""}if(f>=h){j.desc=g.substring(h,f+1)}return j};SocialCalc.ConvertSaveToOtherFormat=function(b,e,k){var h,c,g,a,o,n,d,f,l,j;var m="";if(e=="scsave"){return b}if(b==""){return""}h=new SocialCalc.Sheet();h.ParseSheetSave(b);if(k){throw ("SocialCalc.ConvertSaveToOtherFormat: Not doing recalc.")}if(h.copiedfrom){g=SocialCalc.ParseRange(h.copiedfrom)}else{g={cr1:{row:1,col:1},cr2:{row:h.attribs.lastrow,col:h.attribs.lastcol}}}if(e=="html"){c=new SocialCalc.RenderContext(h);if(h.copiedfrom){c.rowpanes[0]={first:g.cr1.row,last:g.cr2.row};c.colpanes[0]={first:g.cr1.col,last:g.cr2.col}}a=document.createElement("div");o=c.RenderSheet(null,c.defaultHTMLlinkstyle);a.appendChild(o);delete c;delete h;m=a.innerHTML;delete o;delete a;return m}for(n=g.cr1.row;n<=g.cr2.row;n++){for(d=g.cr1.col;d<=g.cr2.col;d++){f=SocialCalc.crToCoord(d,n);l=h.GetAssuredCell(f);if(l.errors){j=l.errors}else{j=l.datavalue+""}if(e=="csv"){if(j.indexOf('"')!=-1){j=j.replace(/"/g,'""')}if(/[, \n"]/.test(j)){j='"'+j+'"'}if(d>g.cr1.col){j=","+j}}else{if(e=="tab"){if(j.indexOf("\n")!=-1){if(j.indexOf('"')!=-1){j=j.replace(/"/g,'""')}j='"'+j+'"'}if(d>g.cr1.col){j="\t"+j}}}m+=j}m+="\n"}return m};SocialCalc.ConvertOtherFormatToSave=function(e,h){var f,d,a,t,m,r,c,s,o,b,l,g,k,q;var n="";var p=function(){g++;if(g>q){q=g}k=SocialCalc.crToCoord(g,l);SocialCalc.SetConvertedCell(f,k,r);r=""};if(h=="scsave"){return e}f=new SocialCalc.Sheet();a=e.split(/\r\n|\n/);q=0;if(h=="csv"){l=0;c=false;for(t=0;t<a.length;t++){if(t==a.length-1&&a[t]==""){break}if(c){r+="\n"}else{r="";l++;g=0}m=a[t];for(s=0;s<m.length;s++){o=m.charAt(s);if(o=='"'){if(c){if(s<m.length-1&&m.charAt(s+1)=='"'){s++;r+='"'}else{c=false;if(s==m.length-1){p()}}}else{c=true}continue}if(o==","&&!c){p()}else{r+=o}if(s==m.length-1&&!c){p()}}}if(q>0){f.attribs.lastrow=l;f.attribs.lastcol=q;n=f.CreateSheetSave("A1:"+SocialCalc.crToCoord(q,l))}}if(h=="tab"){l=0;c=false;for(t=0;t<a.length;t++){if(t==a.length-1&&a[t]==""){break}if(c){r+="\n"}else{r="";l++;g=0}m=a[t];for(s=0;s<m.length;s++){o=m.charAt(s);if(o=='"'){if(c){if(s<m.length-1){if(m.charAt(s+1)=='"'){s++;r+='"'}else{if(m.charAt(s+1)=="\t"){s++;c=false;p()}}}else{c=false;p()}continue}if(r==""){c=true;continue}}if(o=="\t"&&!c){p()}else{r+=o}if(s==m.length-1&&!c){p()}}}if(q>0){f.attribs.lastrow=l;f.attribs.lastcol=q;n=f.CreateSheetSave("A1:"+SocialCalc.crToCoord(q,l))}}return n};SocialCalc.SetConvertedCell=function(c,d,b){var a,e;a=c.GetAssuredCell(d);e=SocialCalc.DetermineValueType(b);if(e.type=="n"&&e.value==b){a.datatype="v";a.valuetype="n";a.datavalue=e.value}else{if(e.type.charAt(0)=="t"){a.datatype="t";a.valuetype=e.type;a.datavalue=e.value}else{a.datatype="c";a.valuetype=e.type;a.datavalue=e.value;a.formula=b}}};